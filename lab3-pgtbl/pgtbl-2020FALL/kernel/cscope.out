cscope 15 $HOME/test/xv6-labs-2020/kernel -q 0000000830 0000101462
	@bio.c

17 
	~"ty≥s.h
"

18 
	~"∑øm.h
"

19 
	~"•ölock.h
"

20 
	~"¶ì∂ock.h
"

21 
	~"riscv.h
"

22 
	~"defs.h
"

23 
	~"fs.h
"

24 
	~"buf.h
"

27 
•ölock
 
	mlock
;

28 
buf
 
	mbuf
[
NBUF
];

33 
buf
 
	mhód
;

34 } 
	gbˇche
;

37 
	$böô
()

39 
buf
 *
b
;

41 
	`öôlock
(&
bˇche
.
lock
, "bcache");

44 
bˇche
.
hód
.
¥ev
 = &bcache.head;

45 
bˇche
.
hód
.
√xt
 = &bcache.head;

46 
b
 = 
bˇche
.
buf
; b < bˇche.buf+
NBUF
; b++){

47 
b
->
√xt
 = 
bˇche
.
hód
.next;

48 
b
->
¥ev
 = &
bˇche
.
hód
;

49 
	`öô¶ì∂ock
(&
b
->
lock
, "buffer");

50 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

51 
bˇche
.
hód
.
√xt
 = 
b
;

53 
	}
}

58 
buf
*

59 
	$bgë
(
uöt
 
dev
, uöà
blockno
)

61 
buf
 *
b
;

63 
	`acquúe
(&
bˇche
.
lock
);

66 
b
 = 
bˇche
.
hód
.
√xt
; b != &bcache.head; b = b->next){

67 if(
b
->
dev
 =dev && b->
blockno
 == blockno){

68 
b
->
ªf˙t
++;

69 
	`ªÀa£
(&
bˇche
.
lock
);

70 
	`acquúe¶ìp
(&
b
->
lock
);

71  
b
;

77 
b
 = 
bˇche
.
hód
.
¥ev
; b != &bcache.head; b = b->prev){

78 if(
b
->
ªf˙t
 == 0) {

79 
b
->
dev
 = dev;

80 
b
->
blockno
 = blockno;

81 
b
->
vÆid
 = 0;

82 
b
->
ªf˙t
 = 1;

83 
	`ªÀa£
(&
bˇche
.
lock
);

84 
	`acquúe¶ìp
(&
b
->
lock
);

85  
b
;

88 
	`∑nic
("bget:Ço buffers");

89 
	}
}

92 
buf
*

93 
	$bªad
(
uöt
 
dev
, uöà
blockno
)

95 
buf
 *
b
;

97 
b
 = 
	`bgë
(
dev
, 
blockno
);

98 if(!
b
->
vÆid
) {

99 
	`vútio_disk_rw
(
b
, 0);

100 
b
->
vÆid
 = 1;

102  
b
;

103 
	}
}

107 
	$bwrôe
(
buf
 *
b
)

109 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

110 
	`∑nic
("bwrite");

111 
	`vútio_disk_rw
(
b
, 1);

112 
	}
}

117 
	$bªl£
(
buf
 *
b
)

119 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

120 
	`∑nic
("brelse");

122 
	`ªÀa£¶ìp
(&
b
->
lock
);

124 
	`acquúe
(&
bˇche
.
lock
);

125 
b
->
ªf˙t
--;

126 i‡(
b
->
ªf˙t
 == 0) {

128 
b
->
√xt
->
¥ev
 = b->prev;

129 
b
->
¥ev
->
√xt
 = b->next;

130 
b
->
√xt
 = 
bˇche
.
hód
.next;

131 
b
->
¥ev
 = &
bˇche
.
hód
;

132 
bˇche
.
hód
.
√xt
->
¥ev
 = 
b
;

133 
bˇche
.
hód
.
√xt
 = 
b
;

136 
	`ªÀa£
(&
bˇche
.
lock
);

137 
	}
}

140 
	$bpö
(
buf
 *
b
) {

141 
	`acquúe
(&
bˇche
.
lock
);

142 
b
->
ªf˙t
++;

143 
	`ªÀa£
(&
bˇche
.
lock
);

144 
	}
}

147 
	$bu≈ö
(
buf
 *
b
) {

148 
	`acquúe
(&
bˇche
.
lock
);

149 
b
->
ªf˙t
--;

150 
	`ªÀa£
(&
bˇche
.
lock
);

151 
	}
}

	@buf.h

1 
	sbuf
 {

2 
	mvÆid
;

3 
	mdisk
;

4 
uöt
 
	mdev
;

5 
uöt
 
	mblockno
;

6 
¶ì∂ock
 
	mlock
;

7 
uöt
 
	mªf˙t
;

8 
buf
 *
	m¥ev
;

9 
buf
 *
	m√xt
;

10 
uch¨
 
	md©a
[
BSIZE
];

	@console.c

12 
	~<°d¨g.h
>

14 
	~"ty≥s.h
"

15 
	~"∑øm.h
"

16 
	~"•ölock.h
"

17 
	~"¶ì∂ock.h
"

18 
	~"fs.h
"

19 
	~"fûe.h
"

20 
	~"memœyout.h
"

21 
	~"riscv.h
"

22 
	~"defs.h
"

23 
	~"¥oc.h
"

25 
	#BACKSPACE
 0x100

	)

26 
	#C
(
x
) ((x)-'@')

27 

	)

34 
	$c⁄•utc
(
c
)

36 if(
c
 =
BACKSPACE
){

38 
	`u¨çutc_sync
('\b'); uartputc_sync(' '); uartputc_sync('\b');

40 
	`u¨çutc_sync
(
c
);

42 
	}
}

45 
•ölock
 
	mlock
;

48 
	#INPUT_BUF
 128

	)

49 
	mbuf
[
INPUT_BUF
];

50 
uöt
 
	mr
;

51 
uöt
 
	mw
;

52 
uöt
 
	me
;

53 } 
	gc⁄s
;

59 
	$c⁄sﬁewrôe
(
u£r_§c
, 
uöt64
 
§c
, 
n
)

61 
i
;

63 
	`acquúe
(&
c⁄s
.
lock
);

64 
i
 = 0; i < 
n
; i++){

65 
c
;

66 if(
	`eôhî_c›yö
(&
c
, 
u£r_§c
, 
§c
+
i
, 1) == -1)

68 
	`u¨çutc
(
c
);

70 
	`ªÀa£
(&
c⁄s
.
lock
);

72  
i
;

73 
	}
}

82 
	$c⁄sﬁîód
(
u£r_d°
, 
uöt64
 
d°
, 
n
)

84 
uöt
 
èrgë
;

85 
c
;

86 
cbuf
;

88 
èrgë
 = 
n
;

89 
	`acquúe
(&
c⁄s
.
lock
);

90 
n
 > 0){

93 
c⁄s
.
r
 =c⁄s.
w
){

94 if(
	`my¥oc
()->
kûÀd
){

95 
	`ªÀa£
(&
c⁄s
.
lock
);

98 
	`¶ìp
(&
c⁄s
.
r
, &c⁄s.
lock
);

101 
c
 = 
c⁄s
.
buf
[c⁄s.
r
++ % 
INPUT_BUF
];

103 if(
c
 =
	`C
('D')){

104 if(
n
 < 
èrgë
){

107 
c⁄s
.
r
--;

113 
cbuf
 = 
c
;

114 if(
	`eôhî_c›yout
(
u£r_d°
, 
d°
, &
cbuf
, 1) == -1)

117 
d°
++;

118 --
n
;

120 if(
c
 == '\n'){

126 
	`ªÀa£
(&
c⁄s
.
lock
);

128  
èrgë
 - 
n
;

129 
	}
}

138 
	$c⁄sﬁeöå
(
c
)

140 
	`acquúe
(&
c⁄s
.
lock
);

142 
c
){

143 
	`C
('P'):

144 
	`¥ocdump
();

146 
	`C
('U'):

147 
c⁄s
.
e
 !c⁄s.
w
 &&

148 
c⁄s
.
buf
[(c⁄s.
e
-1Ë% 
INPUT_BUF
] != '\n'){

149 
c⁄s
.
e
--;

150 
	`c⁄•utc
(
BACKSPACE
);

153 
	`C
('H'):

155 if(
c⁄s
.
e
 !c⁄s.
w
){

156 
c⁄s
.
e
--;

157 
	`c⁄•utc
(
BACKSPACE
);

161 if(
c
 !0 && 
c⁄s
.
e
-c⁄s.
r
 < 
INPUT_BUF
){

162 
c
 = (c == '\r') ? '\n' : c;

165 
	`c⁄•utc
(
c
);

168 
c⁄s
.
buf
[c⁄s.
e
++ % 
INPUT_BUF
] = 
c
;

170 if(
c
 ='\n' || c =
	`C
('D'Ë|| 
c⁄s
.
e
 =c⁄s.
r
+
INPUT_BUF
){

173 
c⁄s
.
w
 = c⁄s.
e
;

174 
	`wakeup
(&
c⁄s
.
r
);

180 
	`ªÀa£
(&
c⁄s
.
lock
);

181 
	}
}

184 
	$c⁄sﬁeöô
()

186 
	`öôlock
(&
c⁄s
.
lock
, "cons");

188 
	`u¨töô
();

192 
devsw
[
CONSOLE
].
ªad
 = 
c⁄sﬁîód
;

193 
devsw
[
CONSOLE
].
wrôe
 = 
c⁄sﬁewrôe
;

194 
	}
}

	@date.h

1 
	sπcd©e
 {

2 
uöt
 
	m£c⁄d
;

3 
uöt
 
	mmöuã
;

4 
uöt
 
	mhour
;

5 
uöt
 
	mday
;

6 
uöt
 
	mm⁄th
;

7 
uöt
 
	myór
;

	@defs.h

1 
	gbuf
;

2 
	gc⁄ãxt
;

3 
	gfûe
;

4 
	göode
;

5 
	gpùe
;

6 
	g¥oc
;

7 
	g•ölock
;

8 
	g¶ì∂ock
;

9 
	g°©
;

10 
	gsu≥rblock
;

11 #ifde‡
LAB_NET


12 
	gmbuf
;

13 
	gsock
;

17 
böô
();

18 
buf
* 
bªad
(
uöt
, uint);

19 
bªl£
(
buf
*);

20 
bwrôe
(
buf
*);

21 
bpö
(
buf
*);

22 
bu≈ö
(
buf
*);

25 
c⁄sﬁeöô
();

26 
c⁄sﬁeöå
();

27 
c⁄•utc
();

30 
exec
(*, **);

33 
fûe
* 
fûóŒoc
();

34 
fûe˛o£
(
fûe
*);

35 
fûe
* 
fûedup
(file*);

36 
fûeöô
();

37 
fûîód
(
fûe
*, 
uöt64
, 
n
);

38 
fûe°©
(
fûe
*, 
uöt64
 
addr
);

39 
fûewrôe
(
fûe
*, 
uöt64
, 
n
);

42 
fsöô
();

43 
dúlök
(
öode
*, *, 
uöt
);

44 
öode
* 
dúlookup
(öode*, *, 
uöt
*);

45 
öode
* 
üŒoc
(
uöt
, );

46 
öode
* 
idup
(inode*);

47 
iöô
();

48 
ûock
(
öode
*);

49 
ùut
(
öode
*);

50 
iu∆ock
(
öode
*);

51 
iu∆ockput
(
öode
*);

52 
iupd©e
(
öode
*);

53 
«mecmp
(const *, const *);

54 
öode
* 
«mei
(*);

55 
öode
* 
«meù¨ít
(*, *);

56 
ªadi
(
öode
*, , 
uöt64
, 
uöt
, uint);

57 
°©i
(
öode
*, 
°©
*);

58 
wrôei
(
öode
*, , 
uöt64
, 
uöt
, uint);

59 
ôrunc
(
öode
*);

62 
ømdisköô
();

63 
ømdisköå
();

64 
ømdiskrw
(
buf
*);

67 * 
kÆloc
();

68 
k‰ì
(*);

69 
köô
();

72 
öôlog
(, 
su≥rblock
*);

73 
log_wrôe
(
buf
*);

74 
begö_›
();

75 
íd_›
();

78 
pùóŒoc
(
fûe
**, file**);

79 
pùe˛o£
(
pùe
*, );

80 
pùîód
(
pùe
*, 
uöt64
, );

81 
pùewrôe
(
pùe
*, 
uöt64
, );

84 
¥ötf
(*, ...);

85 
	$∑nic
(*Ë
	`__©åibuã__
((
n‹ëu∫
));

86 
	`¥ötföô
();

89 
	`˝uid
();

90 
	`exô
();

91 
	`f‹k
();

92 
	`grow¥oc
();

93 
∑gëabÀ_t
 
	`¥oc_∑gëabÀ
(
¥oc
 *);

94 
	`¥oc_‰ì∑gëabÀ
(
∑gëabÀ_t
, 
uöt64
);

95 
	`kûl
();

96 
˝u
* 
	`my˝u
();

97 
˝u
* 
	`gëmy˝u
();

98 
¥oc
* 
	`my¥oc
();

99 
	`¥ocöô
();

100 
	$scheduÀr
(Ë
	`__©åibuã__
((
n‹ëu∫
));

101 
	`sched
();

102 
	`£çroc
(
¥oc
*);

103 
	`¶ìp
(*, 
•ölock
*);

104 
	`u£röô
();

105 
	`waô
(
uöt64
);

106 
	`wakeup
(*);

107 
	`yõld
();

108 
	`eôhî_c›yout
(
u£r_d°
, 
uöt64
 
d°
, *
§c
, uöt64 
Àn
);

109 
	`eôhî_c›yö
(*
d°
, 
u£r_§c
, 
uöt64
 
§c
, uöt64 
Àn
);

110 
	`¥ocdump
();

113 
	`swtch
(
c⁄ãxt
*, context*);

116 
	`acquúe
(
•ölock
*);

117 
	`hﬁdög
(
•ölock
*);

118 
	`öôlock
(
•ölock
*, *);

119 
	`ªÀa£
(
•ölock
*);

120 
	`push_off
();

121 
	`p›_off
();

124 
	`acquúe¶ìp
(
¶ì∂ock
*);

125 
	`ªÀa£¶ìp
(
¶ì∂ock
*);

126 
	`hﬁdög¶ìp
(
¶ì∂ock
*);

127 
	`öô¶ì∂ock
(
¶ì∂ock
*, *);

130 
	`memcmp
(c⁄° *, c⁄° *, 
uöt
);

131 * 
	`memmove
(*, c⁄° *, 
uöt
);

132 * 
	`mem£t
(*, , 
uöt
);

133 * 
	`ß„°r˝y
(*, const *, );

134 
	`°æí
(const *);

135 
	`°∫cmp
(c⁄° *, c⁄° *, 
uöt
);

136 * 
	`°∫˝y
(*, const *, );

139 
	`¨göt
(, *);

140 
	`¨g°r
(, *, );

141 
	`¨gaddr
(, 
uöt64
 *);

142 
	`„tch°r
(
uöt64
, *, );

143 
	`„tchaddr
(
uöt64
, uint64*);

144 
	`sysˇŒ
();

147 
uöt
 
ticks
;

148 
	`å≠öô
();

149 
	`å≠öôh¨t
();

150 
•ölock
 
tick¶ock
;

151 
	`u£πø¥ë
();

154 
	`u¨töô
();

155 
	`u¨töå
();

156 
	`u¨çutc
();

157 
	`u¨çutc_sync
();

158 
	`u¨tgëc
();

161 
	`kvmöô
();

162 
	`kvmöôh¨t
();

163 
uöt64
 
	`kvm∑
(uint64);

164 
	`kvmm≠
(
uöt64
, uint64, uint64, );

165 
	`m≠∑ges
(
∑gëabÀ_t
, 
uöt64
, uint64, uint64, );

166 
∑gëabÀ_t
 
	`uvm¸óã
();

167 
	`uvmöô
(
∑gëabÀ_t
, 
uch¨
 *, 
uöt
);

168 
uöt64
 
	`uvmÆloc
(
∑gëabÀ_t
, uint64, uint64);

169 
uöt64
 
	`kvmÆloc
(
∑gëabÀ_t
 
k∑gëabÀ
, uöt64 
ﬁdsz
, uöt64 
√wsz
);

170 
uöt64
 
	`uvmdóŒoc
(
∑gëabÀ_t
, uint64, uint64);

171 
uöt64
 
	`kvmdóŒoc
(
∑gëabÀ_t
, uint64, uint64);

172 
∑gëabÀ_t
 
	`u£r_kvm¸óã
();

173 
	`u£r_kvmm≠
(
∑gëabÀ_t
 
k∑gëabÀ
,
uöt64
 
va
, uöt64 
sz
,uöt64 
∑
, 
≥rm
);

174 
	`u£r_kvm‰ì
(
∑gëabÀ_t
 
k∑gëabÀ
);

175 #ifde‡
SOL_COW


177 
	`uvmc›y
(
∑gëabÀ_t
,ÖagëabÀ_t, 
uöt64
);

178 
	`kvmc›y
(
∑gëabÀ_t
,ÖagëabÀ_t, 
uöt64
,uint64);

180 
	`uvm‰ì
(
∑gëabÀ_t
, 
uöt64
);

181 
	`uvmunm≠
(
∑gëabÀ_t
, 
uöt64
, uint64, );

182 
	`uvm˛ór
(
∑gëabÀ_t
, 
uöt64
);

183 
uöt64
 
	`wÆkaddr
(
∑gëabÀ_t
, uint64);

184 
	`c›yout
(
∑gëabÀ_t
, 
uöt64
, *, uint64);

185 
	`c›yö
(
∑gëabÀ_t
, *, 
uöt64
, uint64);

186 
	`c›yö°r
(
∑gëabÀ_t
, *, 
uöt64
, uint64);

187 
	`vm¥öt
(
∑gëabÀ_t
 
∑gëabÀ
);

188 
±e_t
 * 
	`wÆk
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
, 
Æloc
);

191 
	`∂icöô
();

192 
	`∂icöôh¨t
();

193 
	`∂ic_˛aim
();

194 
	`∂ic_com∂ëe
();

197 
	`vútio_disk_öô
();

198 
	`vútio_disk_rw
(
buf
 *, );

199 
	`vútio_disk_öå
();

202 
	#NELEM
(
x
Ë((x)/((x)[0]))

	)

207 
	`°©söô
();

208 
	`°©söc
();

211 
	`¢¥ötf
(*, , *, ...);

213 
	`c›yö_√w
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
Àn
);

214 
	`c›yö°r_√w
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
max
);

217 #ifde‡
LAB_NET


219 
	`pci_öô
();

222 
	`e1000_öô
(
uöt32
 *);

223 
	`e1000_öå
();

224 
	`e1000_å™smô
(
mbuf
*);

227 
	`√t_rx
(
mbuf
*);

228 
	`√t_tx_udp
(
mbuf
*, 
uöt32
, 
uöt16
, uint16);

231 
	`socköô
();

232 
	`sockÆloc
(
fûe
 **, 
uöt32
, 
uöt16
, uint16);

233 
	`sock˛o£
(
sock
 *);

234 
	`sockªad
(
sock
 *, 
uöt64
, );

235 
	`sockwrôe
(
sock
 *, 
uöt64
, );

236 
	`sockªcvudp
(
mbuf
*, 
uöt32
, 
uöt16
, uint16);

	@elf.h

3 
	#ELF_MAGIC
 0x464C457FU

4 

	)

6 
	sñfhdr
 {

7 
uöt
 
	mmagic
;

8 
uch¨
 
	mñf
[12];

9 
ush‹t
 
	mty≥
;

10 
ush‹t
 
	mmachöe
;

11 
uöt
 
	mvîsi⁄
;

12 
uöt64
 
	míåy
;

13 
uöt64
 
	mphoff
;

14 
uöt64
 
	mshoff
;

15 
uöt
 
	mÊags
;

16 
ush‹t
 
	mehsize
;

17 
ush‹t
 
	mphítsize
;

18 
ush‹t
 
	mphnum
;

19 
ush‹t
 
	mshítsize
;

20 
ush‹t
 
	mshnum
;

21 
ush‹t
 
	msh°∫dx
;

25 
	s¥oghdr
 {

26 
uöt32
 
	mty≥
;

27 
uöt32
 
	mÊags
;

28 
uöt64
 
	moff
;

29 
uöt64
 
	mvaddr
;

30 
uöt64
 
	m∑ddr
;

31 
uöt64
 
	mfûesz
;

32 
uöt64
 
	mmemsz
;

33 
uöt64
 
	mÆign
;

37 
	#ELF_PROG_LOAD
 1

	)

40 
	#ELF_PROG_FLAG_EXEC
 1

	)

41 
	#ELF_PROG_FLAG_WRITE
 2

	)

42 
	#ELF_PROG_FLAG_READ
 4

	)

	@exec.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

7 
	~"defs.h
"

8 
	~"ñf.h
"

10 
lﬂd£g
(
pde_t
 *
pgdú
, 
uöt64
 
addr
, 
öode
 *
ù
, 
uöt
 
off£t
, uöà
sz
);

12 
	$exec
(*
∑th
, **
¨gv
)

15 *
s
, *
œ°
;

16 
i
, 
off
;

17 
uöt64
 
¨gc
, 
sz
 = 0, 
•
, 
u°ack
[
MAXARG
+1], 
°ackba£
;

18 
ñfhdr
 
ñf
;

19 
öode
 *
ù
;

20 
¥oghdr
 
ph
;

21 
∑gëabÀ_t
 
∑gëabÀ
 = 0, 
ﬁd∑gëabÀ
;

22 
¥oc
 *
p
 = 
	`my¥oc
();

23 
	`begö_›
();

25 if((
ù
 = 
	`«mei
(
∑th
)) == 0){

26 
	`íd_›
();

29 
	`ûock
(
ù
);

31 if(
	`ªadi
(
ù
, 0, (
uöt64
)&
ñf
, 0, (elf)) != (elf))

32 
bad
;

33 if(
ñf
.
magic
 !
ELF_MAGIC
)

34 
bad
;

35 if((
∑gëabÀ
 = 
	`¥oc_∑gëabÀ
(
p
)) == 0)

36 
bad
;

39 
i
=0, 
off
=
ñf
.
phoff
; i<ñf.
phnum
; i++, off+=(
ph
)){

40 if(
	`ªadi
(
ù
, 0, (
uöt64
)&
ph
, 
off
, (ph)) != (ph))

41 
bad
;

42 if(
ph
.
ty≥
 !
ELF_PROG_LOAD
)

44 if(
ph
.
memsz
 <Öh.
fûesz
)

45 
bad
;

46 if(
ph
.
vaddr
 +Öh.
memsz
 <Öh.vaddr)

47 
bad
;

48 
uöt64
 
sz1
;

49 if((
sz1
 = 
	`uvmÆloc
(
∑gëabÀ
, 
sz
, 
ph
.
vaddr
 +Öh.
memsz
)) == 0)

50 
bad
;

51 
sz
 = 
sz1
;

52 if(
ph
.
vaddr
 % 
PGSIZE
 != 0)

53 
bad
;

54 if(
	`lﬂd£g
(
∑gëabÀ
, 
ph
.
vaddr
, 
ù
,Öh.
off
,Öh.
fûesz
) < 0)

55 
bad
;

57 
	`iu∆ockput
(
ù
);

58 
	`íd_›
();

59 
ù
 = 0;

61 
p
 = 
	`my¥oc
();

62 
uöt64
 
ﬁdsz
 = 
p
->
sz
;

66 
sz
 = 
	`PGROUNDUP
(sz);

67 
uöt64
 
sz1
;

69 if((
sz1
 = 
	`uvmÆloc
(
∑gëabÀ
, 
sz
, sz + 2*
PGSIZE
)) == 0)

70 
bad
;

71 
sz
 = 
sz1
;

72 
	`uvm˛ór
(
∑gëabÀ
, 
sz
-2*
PGSIZE
);

73 
•
 = 
sz
;

74 
°ackba£
 = 
•
 - 
PGSIZE
;

76 
¨gc
 = 0; 
¨gv
[argc];árgc++) {

77 if(
¨gc
 >
MAXARG
)

78 
bad
;

79 
•
 -
	`°æí
(
¨gv
[
¨gc
]) + 1;

80 
•
 -= sp % 16;

81 if(
•
 < 
°ackba£
)

82 
bad
;

83 if(
	`c›yout
(
∑gëabÀ
, 
•
, 
¨gv
[
¨gc
], 
	`°æí
(argv[argc]) + 1) < 0)

84 
bad
;

85 
u°ack
[
¨gc
] = 
•
;

87 
u°ack
[
¨gc
] = 0;

90 
•
 -(
¨gc
+1Ë* (
uöt64
);

91 
•
 -= sp % 16;

92 if(
•
 < 
°ackba£
)

93 
bad
;

94 if(
	`c›yout
(
∑gëabÀ
, 
•
, (*)
u°ack
, (
¨gc
+1)*(
uöt64
)) < 0)

95 
bad
;

99 
p
->
å≠‰ame
->
a1
 = 
•
;

102 
œ°
=
s
=
∑th
; *s; s++)

103 if(*
s
 == '/')

104 
œ°
 = 
s
+1;

105 
	`ß„°r˝y
(
p
->
«me
, 
œ°
, (p->name));

106 
	`kvmdóŒoc
(
p
->
k∑gëabÀ
,
ﬁdsz
,0);

107 
	`kvmc›y
(
∑gëabÀ
,
p
->
k∑gëabÀ
,0,
sz
);

110 
ﬁd∑gëabÀ
 = 
p
->
∑gëabÀ
;

111 
p
->
∑gëabÀ
 =Öagetable;

112 
p
->
sz
 = sz;

113 
p
->
å≠‰ame
->
ïc
 = 
ñf
.
íåy
;

114 
p
->
å≠‰ame
->
•
 = sp;

115 
	`¥oc_‰ì∑gëabÀ
(
ﬁd∑gëabÀ
, 
ﬁdsz
);

120 if(
p
->
pid
 =1Ë
	`vm¥öt
(
∑gëabÀ
);

121  
¨gc
;

123 
bad
:

124 if(
∑gëabÀ
)

125 
	`¥oc_‰ì∑gëabÀ
(
∑gëabÀ
, 
sz
);

126 if(
ù
){

127 
	`iu∆ockput
(
ù
);

128 
	`íd_›
();

132 
	}
}

139 
	$lﬂd£g
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
, 
öode
 *
ù
, 
uöt
 
off£t
, uöà
sz
)

141 
uöt
 
i
, 
n
;

142 
uöt64
 
∑
;

144 if((
va
 % 
PGSIZE
) != 0)

145 
	`∑nic
("loadseg: va must beÖageáligned");

147 
i
 = 0; i < 
sz
; i +
PGSIZE
){

148 
∑
 = 
	`wÆkaddr
(
∑gëabÀ
, 
va
 + 
i
);

149 if(
∑
 == 0)

150 
	`∑nic
("loadseg:áddress shouldÉxist");

151 if(
sz
 - 
i
 < 
PGSIZE
)

152 
n
 = 
sz
 - 
i
;

154 
n
 = 
PGSIZE
;

155 if(
	`ªadi
(
ù
, 0, (
uöt64
)
∑
, 
off£t
+
i
, 
n
) !=Ç)

160 
	}
}

	@fcntl.h

1 
	#O_RDONLY
 0x000

	)

2 
	#O_WRONLY
 0x001

	)

3 
	#O_RDWR
 0x002

	)

4 
	#O_CREATE
 0x200

	)

5 
	#O_TRUNC
 0x400

	)

	@file.c

5 
	~"ty≥s.h
"

6 
	~"riscv.h
"

7 
	~"defs.h
"

8 
	~"∑øm.h
"

9 
	~"fs.h
"

10 
	~"•ölock.h
"

11 
	~"¶ì∂ock.h
"

12 
	~"fûe.h
"

13 
	~"°©.h
"

14 
	~"¥oc.h
"

16 
devsw
 
	gdevsw
[
NDEV
];

18 
•ölock
 
	mlock
;

19 
fûe
 
	mfûe
[
NFILE
];

20 } 
	g·abÀ
;

23 
	$fûeöô
()

25 
	`öôlock
(&
·abÀ
.
lock
, "ftable");

26 
	}
}

29 
fûe
*

30 
	$fûóŒoc
()

32 
fûe
 *
f
;

34 
	`acquúe
(&
·abÀ
.
lock
);

35 
f
 = 
·abÀ
.
fûe
; f < fèbÀ.fûê+ 
NFILE
; f++){

36 if(
f
->
ªf
 == 0){

37 
f
->
ªf
 = 1;

38 
	`ªÀa£
(&
·abÀ
.
lock
);

39  
f
;

42 
	`ªÀa£
(&
·abÀ
.
lock
);

44 
	}
}

47 
fûe
*

48 
	$fûedup
(
fûe
 *
f
)

50 
	`acquúe
(&
·abÀ
.
lock
);

51 if(
f
->
ªf
 < 1)

52 
	`∑nic
("filedup");

53 
f
->
ªf
++;

54 
	`ªÀa£
(&
·abÀ
.
lock
);

55  
f
;

56 
	}
}

60 
	$fûe˛o£
(
fûe
 *
f
)

62 
fûe
 
ff
;

64 
	`acquúe
(&
·abÀ
.
lock
);

65 if(
f
->
ªf
 < 1)

66 
	`∑nic
("fileclose");

67 if(--
f
->
ªf
 > 0){

68 
	`ªÀa£
(&
·abÀ
.
lock
);

71 
ff
 = *
f
;

72 
f
->
ªf
 = 0;

73 
f
->
ty≥
 = 
FD_NONE
;

74 
	`ªÀa£
(&
·abÀ
.
lock
);

76 if(
ff
.
ty≥
 =
FD_PIPE
){

77 
	`pùe˛o£
(
ff
.
pùe
, ff.
wrôabÀ
);

78 } if(
ff
.
ty≥
 =
FD_INODE
 || ff.ty≥ =
FD_DEVICE
){

79 
	`begö_›
();

80 
	`ùut
(
ff
.
ù
);

81 
	`íd_›
();

83 
	}
}

88 
	$fûe°©
(
fûe
 *
f
, 
uöt64
 
addr
)

90 
¥oc
 *
p
 = 
	`my¥oc
();

91 
°©
 
°
;

93 if(
f
->
ty≥
 =
FD_INODE
 || f->ty≥ =
FD_DEVICE
){

94 
	`ûock
(
f
->
ù
);

95 
	`°©i
(
f
->
ù
, &
°
);

96 
	`iu∆ock
(
f
->
ù
);

97 if(
	`c›yout
(
p
->
∑gëabÀ
, 
addr
, (*)&
°
, (st)) < 0)

102 
	}
}

107 
	$fûîód
(
fûe
 *
f
, 
uöt64
 
addr
, 
n
)

109 
r
 = 0;

111 if(
f
->
ªadabÀ
 == 0)

114 if(
f
->
ty≥
 =
FD_PIPE
){

115 
r
 = 
	`pùîód
(
f
->
pùe
, 
addr
, 
n
);

116 } if(
f
->
ty≥
 =
FD_DEVICE
){

117 if(
f
->
maj‹
 < 0 || f->maj‹ >
NDEV
 || !
devsw
[f->maj‹].
ªad
)

119 
r
 = 
devsw
[
f
->
maj‹
].
	`ªad
(1, 
addr
, 
n
);

120 } if(
f
->
ty≥
 =
FD_INODE
){

121 
	`ûock
(
f
->
ù
);

122 if((
r
 = 
	`ªadi
(
f
->
ù
, 1, 
addr
, f->
off
, 
n
)) > 0)

123 
f
->
off
 +
r
;

124 
	`iu∆ock
(
f
->
ù
);

126 
	`∑nic
("fileread");

129  
r
;

130 
	}
}

135 
	$fûewrôe
(
fûe
 *
f
, 
uöt64
 
addr
, 
n
)

137 
r
, 
ªt
 = 0;

139 if(
f
->
wrôabÀ
 == 0)

142 if(
f
->
ty≥
 =
FD_PIPE
){

143 
ªt
 = 
	`pùewrôe
(
f
->
pùe
, 
addr
, 
n
);

144 } if(
f
->
ty≥
 =
FD_DEVICE
){

145 if(
f
->
maj‹
 < 0 || f->maj‹ >
NDEV
 || !
devsw
[f->maj‹].
wrôe
)

147 
ªt
 = 
devsw
[
f
->
maj‹
].
	`wrôe
(1, 
addr
, 
n
);

148 } if(
f
->
ty≥
 =
FD_INODE
){

155 
max
 = ((
MAXOPBLOCKS
-1-1-2Ë/ 2Ë* 
BSIZE
;

156 
i
 = 0;

157 
i
 < 
n
){

158 
n1
 = 
n
 - 
i
;

159 if(
n1
 > 
max
)

160 
n1
 = 
max
;

162 
	`begö_›
();

163 
	`ûock
(
f
->
ù
);

164 i‡((
r
 = 
	`wrôei
(
f
->
ù
, 1, 
addr
 + 
i
, f->
off
, 
n1
)) > 0)

165 
f
->
off
 +
r
;

166 
	`iu∆ock
(
f
->
ù
);

167 
	`íd_›
();

169 if(
r
 < 0)

171 if(
r
 !
n1
)

172 
	`∑nic
("short filewrite");

173 
i
 +
r
;

175 
ªt
 = (
i
 =
n
 ?Ç : -1);

177 
	`∑nic
("filewrite");

180  
ªt
;

181 
	}
}

	@file.h

1 
	sfûe
 {

2 #ifde‡
LAB_NET


3 íum { 
	mFD_NONE
, 
	mFD_PIPE
, 
	mFD_INODE
, 
	mFD_DEVICE
, 
	mFD_SOCK
 } 
	mty≥
;

5 íum { 
	mFD_NONE
, 
	mFD_PIPE
, 
	mFD_INODE
, 
	mFD_DEVICE
 } 
	mty≥
;

7 
	mªf
;

8 
	mªadabÀ
;

9 
	mwrôabÀ
;

10 
pùe
 *
	mpùe
;

11 
öode
 *
	mù
;

12 #ifde‡
LAB_NET


13 
sock
 *
	msock
;

15 
uöt
 
	moff
;

16 
	mmaj‹
;

19 
	#maj‹
(
dev
Ë((devË>> 16 & 0xFFFF)

	)

20 
	#mö‹
(
dev
Ë((devË& 0xFFFF)

	)

21 
	#mkdev
(
m
,
n
Ë((
uöt
)((m)<<16| (n)))

	)

24 
	söode
 {

25 
uöt
 
	mdev
;

26 
uöt
 
	möum
;

27 
	mªf
;

28 
¶ì∂ock
 
	mlock
;

29 
	mvÆid
;

31 
	mty≥
;

32 
	mmaj‹
;

33 
	mmö‹
;

34 
	m∆ök
;

35 
uöt
 
	msize
;

36 #ifde‡
SOL_FS


38 
uöt
 
	maddrs
[
NDIRECT
+1];

43 
	sdevsw
 {

44 (*
	mªad
)(, 
	muöt64
, );

45 (*
	mwrôe
)(, 
	muöt64
, );

48 
devsw
 devsw[];

50 
	#CONSOLE
 1

	)

51 
	#STATS
 2

	)

	@fs.c

12 
	~"ty≥s.h
"

13 
	~"riscv.h
"

14 
	~"defs.h
"

15 
	~"∑øm.h
"

16 
	~"°©.h
"

17 
	~"•ölock.h
"

18 
	~"¥oc.h
"

19 
	~"¶ì∂ock.h
"

20 
	~"fs.h
"

21 
	~"buf.h
"

22 
	~"fûe.h
"

24 
	#mö
(
a
, 
b
Ë(◊Ë< (bË? (aË: (b))

	)

27 
su≥rblock
 
	gsb
;

31 
	$ªadsb
(
dev
, 
su≥rblock
 *
sb
)

33 
buf
 *
bp
;

35 
bp
 = 
	`bªad
(
dev
, 1);

36 
	`memmove
(
sb
, 
bp
->
d©a
, (*sb));

37 
	`bªl£
(
bp
);

38 
	}
}

42 
	$fsöô
(
dev
) {

43 
	`ªadsb
(
dev
, &
sb
);

44 if(
sb
.
magic
 !
FSMAGIC
)

45 
	`∑nic
("invalid file system");

46 
	`öôlog
(
dev
, &
sb
);

47 
	}
}

51 
	$bzîo
(
dev
, 
bno
)

53 
buf
 *
bp
;

55 
bp
 = 
	`bªad
(
dev
, 
bno
);

56 
	`mem£t
(
bp
->
d©a
, 0, 
BSIZE
);

57 
	`log_wrôe
(
bp
);

58 
	`bªl£
(
bp
);

59 
	}
}

64 
uöt


65 
	$bÆloc
(
uöt
 
dev
)

67 
b
, 
bi
, 
m
;

68 
buf
 *
bp
;

70 
bp
 = 0;

71 
b
 = 0; b < 
sb
.
size
; b +
BPB
){

72 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

73 
bi
 = 0; bò< 
BPB
 && 
b
 + bò< 
sb
.
size
; bi++){

74 
m
 = 1 << (
bi
 % 8);

75 if((
bp
->
d©a
[
bi
/8] & 
m
) == 0){

76 
bp
->
d©a
[
bi
/8] |
m
;

77 
	`log_wrôe
(
bp
);

78 
	`bªl£
(
bp
);

79 
	`bzîo
(
dev
, 
b
 + 
bi
);

80  
b
 + 
bi
;

83 
	`bªl£
(
bp
);

85 
	`∑nic
("balloc: out of blocks");

86 
	}
}

90 
	$b‰ì
(
dev
, 
uöt
 
b
)

92 
buf
 *
bp
;

93 
bi
, 
m
;

95 
bp
 = 
	`bªad
(
dev
, 
	`BBLOCK
(
b
, 
sb
));

96 
bi
 = 
b
 % 
BPB
;

97 
m
 = 1 << (
bi
 % 8);

98 if((
bp
->
d©a
[
bi
/8] & 
m
) == 0)

99 
	`∑nic
("freeing free block");

100 
bp
->
d©a
[
bi
/8] &~
m
;

101 
	`log_wrôe
(
bp
);

102 
	`bªl£
(
bp
);

103 
	}
}

175 
•ölock
 
	mlock
;

176 
öode
 
	möode
[
NINODE
];

177 } 
	giˇche
;

180 
	$iöô
()

182 
i
 = 0;

184 
	`öôlock
(&
iˇche
.
lock
, "icache");

185 
i
 = 0; i < 
NINODE
; i++) {

186 
	`öô¶ì∂ock
(&
iˇche
.
öode
[
i
].
lock
, "inode");

188 
	}
}

190 
öode
* 
igë
(
uöt
 
dev
, uöà
öum
);

195 
öode
*

196 
	$üŒoc
(
uöt
 
dev
, 
ty≥
)

198 
öum
;

199 
buf
 *
bp
;

200 
döode
 *
dù
;

202 
öum
 = 1; inum < 
sb
.
nöodes
; inum++){

203 
bp
 = 
	`bªad
(
dev
, 
	`IBLOCK
(
öum
, 
sb
));

204 
dù
 = (
döode
*)
bp
->
d©a
 + 
öum
%
IPB
;

205 if(
dù
->
ty≥
 == 0){

206 
	`mem£t
(
dù
, 0, (*dip));

207 
dù
->
ty≥
 =Åype;

208 
	`log_wrôe
(
bp
);

209 
	`bªl£
(
bp
);

210  
	`igë
(
dev
, 
öum
);

212 
	`bªl£
(
bp
);

214 
	`∑nic
("ialloc:Ço inodes");

215 
	}
}

222 
	$iupd©e
(
öode
 *
ù
)

224 
buf
 *
bp
;

225 
döode
 *
dù
;

227 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

228 
dù
 = (
döode
*)
bp
->
d©a
 + 
ù
->
öum
%
IPB
;

229 
dù
->
ty≥
 = 
ù
->type;

230 
dù
->
maj‹
 = 
ù
->major;

231 
dù
->
mö‹
 = 
ù
->minor;

232 
dù
->
∆ök
 = 
ù
->nlink;

233 
dù
->
size
 = 
ù
->size;

234 
	`memmove
(
dù
->
addrs
, 
ù
->addrs, (ip->addrs));

235 
	`log_wrôe
(
bp
);

236 
	`bªl£
(
bp
);

237 
	}
}

242 
öode
*

243 
	$igë
(
uöt
 
dev
, uöà
öum
)

245 
öode
 *
ù
, *
em±y
;

247 
	`acquúe
(&
iˇche
.
lock
);

250 
em±y
 = 0;

251 
ù
 = &
iˇche
.
öode
[0]; i∞< &iˇche.öode[
NINODE
]; ip++){

252 if(
ù
->
ªf
 > 0 && ip->
dev
 =dev && ip->
öum
 == inum){

253 
ù
->
ªf
++;

254 
	`ªÀa£
(&
iˇche
.
lock
);

255  
ù
;

257 if(
em±y
 =0 && 
ù
->
ªf
 == 0)

258 
em±y
 = 
ù
;

262 if(
em±y
 == 0)

263 
	`∑nic
("iget:Ço inodes");

265 
ù
 = 
em±y
;

266 
ù
->
dev
 = dev;

267 
ù
->
öum
 = inum;

268 
ù
->
ªf
 = 1;

269 
ù
->
vÆid
 = 0;

270 
	`ªÀa£
(&
iˇche
.
lock
);

272  
ù
;

273 
	}
}

277 
öode
*

278 
	$idup
(
öode
 *
ù
)

280 
	`acquúe
(&
iˇche
.
lock
);

281 
ù
->
ªf
++;

282 
	`ªÀa£
(&
iˇche
.
lock
);

283  
ù
;

284 
	}
}

289 
	$ûock
(
öode
 *
ù
)

291 
buf
 *
bp
;

292 
döode
 *
dù
;

294 if(
ù
 =0 || ip->
ªf
 < 1)

295 
	`∑nic
("ilock");

297 
	`acquúe¶ìp
(&
ù
->
lock
);

299 if(
ù
->
vÆid
 == 0){

300 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`IBLOCK
(ù->
öum
, 
sb
));

301 
dù
 = (
döode
*)
bp
->
d©a
 + 
ù
->
öum
%
IPB
;

302 
ù
->
ty≥
 = 
dù
->type;

303 
ù
->
maj‹
 = 
dù
->major;

304 
ù
->
mö‹
 = 
dù
->minor;

305 
ù
->
∆ök
 = 
dù
->nlink;

306 
ù
->
size
 = 
dù
->size;

307 
	`memmove
(
ù
->
addrs
, 
dù
->addrs, (ip->addrs));

308 
	`bªl£
(
bp
);

309 
ù
->
vÆid
 = 1;

310 if(
ù
->
ty≥
 == 0)

311 
	`∑nic
("ilock:ÇoÅype");

313 
	}
}

317 
	$iu∆ock
(
öode
 *
ù
)

319 if(
ù
 =0 || !
	`hﬁdög¶ìp
(&ù->
lock
Ë|| ip->
ªf
 < 1)

320 
	`∑nic
("iunlock");

322 
	`ªÀa£¶ìp
(&
ù
->
lock
);

323 
	}
}

333 
	$ùut
(
öode
 *
ù
)

335 
	`acquúe
(&
iˇche
.
lock
);

337 if(
ù
->
ªf
 =1 && ip->
vÆid
 && ip->
∆ök
 == 0){

342 
	`acquúe¶ìp
(&
ù
->
lock
);

344 
	`ªÀa£
(&
iˇche
.
lock
);

346 
	`ôrunc
(
ù
);

347 
ù
->
ty≥
 = 0;

348 
	`iupd©e
(
ù
);

349 
ù
->
vÆid
 = 0;

351 
	`ªÀa£¶ìp
(&
ù
->
lock
);

353 
	`acquúe
(&
iˇche
.
lock
);

356 
ù
->
ªf
--;

357 
	`ªÀa£
(&
iˇche
.
lock
);

358 
	}
}

362 
	$iu∆ockput
(
öode
 *
ù
)

364 
	`iu∆ock
(
ù
);

365 
	`ùut
(
ù
);

366 
	}
}

377 
uöt


378 
	$bm≠
(
öode
 *
ù
, 
uöt
 
bn
)

380 
uöt
 
addr
, *
a
;

381 
buf
 *
bp
;

383 if(
bn
 < 
NDIRECT
){

384 if((
addr
 = 
ù
->
addrs
[
bn
]) == 0)

385 
ù
->
addrs
[
bn
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

386  
addr
;

388 
bn
 -
NDIRECT
;

390 if(
bn
 < 
NINDIRECT
){

392 if((
addr
 = 
ù
->
addrs
[
NDIRECT
]) == 0)

393 
ù
->
addrs
[
NDIRECT
] = 
addr
 = 
	`bÆloc
(ù->
dev
);

394 
bp
 = 
	`bªad
(
ù
->
dev
, 
addr
);

395 
a
 = (
uöt
*)
bp
->
d©a
;

396 if((
addr
 = 
a
[
bn
]) == 0){

397 
a
[
bn
] = 
addr
 = 
	`bÆloc
(
ù
->
dev
);

398 
	`log_wrôe
(
bp
);

400 
	`bªl£
(
bp
);

401  
addr
;

404 
	`∑nic
("bmap: out ofÑange");

405 
	}
}

410 
	$ôrunc
(
öode
 *
ù
)

412 
i
, 
j
;

413 
buf
 *
bp
;

414 
uöt
 *
a
;

416 
i
 = 0; i < 
NDIRECT
; i++){

417 if(
ù
->
addrs
[
i
]){

418 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
i
]);

419 
ù
->
addrs
[
i
] = 0;

423 if(
ù
->
addrs
[
NDIRECT
]){

424 
bp
 = 
	`bªad
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

425 
a
 = (
uöt
*)
bp
->
d©a
;

426 
j
 = 0; j < 
NINDIRECT
; j++){

427 if(
a
[
j
])

428 
	`b‰ì
(
ù
->
dev
, 
a
[
j
]);

430 
	`bªl£
(
bp
);

431 
	`b‰ì
(
ù
->
dev
, ip->
addrs
[
NDIRECT
]);

432 
ù
->
addrs
[
NDIRECT
] = 0;

435 
ù
->
size
 = 0;

436 
	`iupd©e
(
ù
);

437 
	}
}

442 
	$°©i
(
öode
 *
ù
, 
°©
 *
°
)

444 
°
->
dev
 = 
ù
->dev;

445 
°
->
öo
 = 
ù
->
öum
;

446 
°
->
ty≥
 = 
ù
->type;

447 
°
->
∆ök
 = 
ù
->nlink;

448 
°
->
size
 = 
ù
->size;

449 
	}
}

456 
	$ªadi
(
öode
 *
ù
, 
u£r_d°
, 
uöt64
 
d°
, 
uöt
 
off
, uöà
n
)

458 
uöt
 
tŸ
, 
m
;

459 
buf
 *
bp
;

461 if(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

463 if(
off
 + 
n
 > 
ù
->
size
)

464 
n
 = 
ù
->
size
 - 
off
;

466 
tŸ
=0;ÅŸ<
n
;ÅŸ+=
m
, 
off
+=m, 
d°
+=m){

467 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
/
BSIZE
));

468 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
%BSIZE);

469 if(
	`eôhî_c›yout
(
u£r_d°
, 
d°
, 
bp
->
d©a
 + (
off
 % 
BSIZE
), 
m
) == -1) {

470 
	`bªl£
(
bp
);

473 
	`bªl£
(
bp
);

475  
tŸ
;

476 
	}
}

483 
	$wrôei
(
öode
 *
ù
, 
u£r_§c
, 
uöt64
 
§c
, 
uöt
 
off
, uöà
n
)

485 
uöt
 
tŸ
, 
m
;

486 
buf
 *
bp
;

488 if(
off
 > 
ù
->
size
 || of‡+ 
n
 < off)

490 if(
off
 + 
n
 > 
MAXFILE
*
BSIZE
)

493 
tŸ
=0;ÅŸ<
n
;ÅŸ+=
m
, 
off
+=m, 
§c
+=m){

494 
bp
 = 
	`bªad
(
ù
->
dev
, 
	`bm≠
(ù, 
off
/
BSIZE
));

495 
m
 = 
	`mö
(
n
 - 
tŸ
, 
BSIZE
 - 
off
%BSIZE);

496 if(
	`eôhî_c›yö
(
bp
->
d©a
 + (
off
 % 
BSIZE
), 
u£r_§c
, 
§c
, 
m
) == -1) {

497 
	`bªl£
(
bp
);

500 
	`log_wrôe
(
bp
);

501 
	`bªl£
(
bp
);

504 if(
n
 > 0){

505 if(
off
 > 
ù
->
size
)

506 
ù
->
size
 = 
off
;

510 
	`iupd©e
(
ù
);

513  
n
;

514 
	}
}

519 
	$«mecmp
(c⁄° *
s
, c⁄° *
t
)

521  
	`°∫cmp
(
s
, 
t
, 
DIRSIZ
);

522 
	}
}

526 
öode
*

527 
	$dúlookup
(
öode
 *
dp
, *
«me
, 
uöt
 *
poff
)

529 
uöt
 
off
, 
öum
;

530 
dúít
 
de
;

532 if(
dp
->
ty≥
 !
T_DIR
)

533 
	`∑nic
("dirlookupÇot DIR");

535 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
)){

536 if(
	`ªadi
(
dp
, 0, (
uöt64
)&
de
, 
off
, (de)) != (de))

537 
	`∑nic
("dirlookupÑead");

538 if(
de
.
öum
 == 0)

540 if(
	`«mecmp
(
«me
, 
de
.name) == 0){

542 if(
poff
)

543 *
poff
 = 
off
;

544 
öum
 = 
de
.inum;

545  
	`igë
(
dp
->
dev
, 
öum
);

550 
	}
}

554 
	$dúlök
(
öode
 *
dp
, *
«me
, 
uöt
 
öum
)

556 
off
;

557 
dúít
 
de
;

558 
öode
 *
ù
;

561 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, 0)) != 0){

562 
	`ùut
(
ù
);

567 
off
 = 0; of‡< 
dp
->
size
; of‡+(
de
)){

568 if(
	`ªadi
(
dp
, 0, (
uöt64
)&
de
, 
off
, (de)) != (de))

569 
	`∑nic
("dirlinkÑead");

570 if(
de
.
öum
 == 0)

574 
	`°∫˝y
(
de
.
«me
,Çame, 
DIRSIZ
);

575 
de
.
öum
 = inum;

576 if(
	`wrôei
(
dp
, 0, (
uöt64
)&
de
, 
off
, (de)) != (de))

577 
	`∑nic
("dirlink");

580 
	}
}

597 
	$skùñem
(*
∑th
, *
«me
)

599 *
s
;

600 
Àn
;

602 *
∑th
 == '/')

603 
∑th
++;

604 if(*
∑th
 == 0)

606 
s
 = 
∑th
;

607 *
∑th
 != '/' && *path != 0)

608 
∑th
++;

609 
Àn
 = 
∑th
 - 
s
;

610 if(
Àn
 >
DIRSIZ
)

611 
	`memmove
(
«me
, 
s
, 
DIRSIZ
);

613 
	`memmove
(
«me
, 
s
, 
Àn
);

614 
«me
[
Àn
] = 0;

616 *
∑th
 == '/')

617 
∑th
++;

618  
∑th
;

619 
	}
}

625 
öode
*

626 
	$«mex
(*
∑th
, 
«meù¨ít
, *
«me
)

628 
öode
 *
ù
, *
√xt
;

630 if(*
∑th
 == '/')

631 
ù
 = 
	`igë
(
ROOTDEV
, 
ROOTINO
);

633 
ù
 = 
	`idup
(
	`my¥oc
()->
cwd
);

635 (
∑th
 = 
	`skùñem
’©h, 
«me
)) != 0){

636 
	`ûock
(
ù
);

637 if(
ù
->
ty≥
 !
T_DIR
){

638 
	`iu∆ockput
(
ù
);

641 if(
«meù¨ít
 && *
∑th
 == '\0'){

643 
	`iu∆ock
(
ù
);

644  
ù
;

646 if((
√xt
 = 
	`dúlookup
(
ù
, 
«me
, 0)) == 0){

647 
	`iu∆ockput
(
ù
);

650 
	`iu∆ockput
(
ù
);

651 
ù
 = 
√xt
;

653 if(
«meù¨ít
){

654 
	`ùut
(
ù
);

657  
ù
;

658 
	}
}

660 
öode
*

661 
	$«mei
(*
∑th
)

663 
«me
[
DIRSIZ
];

664  
	`«mex
(
∑th
, 0, 
«me
);

665 
	}
}

667 
öode
*

668 
	$«meù¨ít
(*
∑th
, *
«me
)

670  
	`«mex
(
∑th
, 1, 
«me
);

671 
	}
}

	@fs.h

5 
	#ROOTINO
 1

6 
	#BSIZE
 1024

7 

	)

14 
	ssu≥rblock
 {

15 
uöt
 
	mmagic
;

16 
uöt
 
	msize
;

17 
uöt
 
	mnblocks
;

18 
uöt
 
	mnöodes
;

19 
uöt
 
	m∆og
;

20 
uöt
 
	mlog°¨t
;

21 
uöt
 
	möode°¨t
;

22 
uöt
 
	mbm≠°¨t
;

25 
	#FSMAGIC
 0x10203040

	)

27 
	#NDIRECT
 12

	)

28 
	#NINDIRECT
 (
BSIZE
 / (
uöt
))

	)

29 
	#MAXFILE
 (
NDIRECT
 + 
NINDIRECT
)

	)

32 
	sdöode
 {

33 
	mty≥
;

34 
	mmaj‹
;

35 
	mmö‹
;

36 
	m∆ök
;

37 
uöt
 
	msize
;

38 
uöt
 
	maddrs
[
NDIRECT
+1];

42 
	#IPB
 (
BSIZE
 / (
döode
))

	)

45 
	#IBLOCK
(
i
, 
sb
Ë((iË/ 
IPB
 + sb.
öode°¨t
)

	)

48 
	#BPB
 (
BSIZE
*8)

	)

51 
	#BBLOCK
(
b
, 
sb
Ë((b)/
BPB
 + sb.
bm≠°¨t
)

	)

54 
	#DIRSIZ
 14

	)

56 
	sdúít
 {

57 
ush‹t
 
	möum
;

58 
	m«me
[
DIRSIZ
];

	@kalloc.c

5 
	~"ty≥s.h
"

6 
	~"∑øm.h
"

7 
	~"memœyout.h
"

8 
	~"•ölock.h
"

9 
	~"riscv.h
"

10 
	~"defs.h
"

12 
‰ìønge
(*
∑_°¨t
, *
∑_íd
);

14 
íd
[];

17 
	srun
 {

18 
run
 *
	m√xt
;

22 
•ölock
 
	mlock
;

23 
run
 *
	m‰ìli°
;

24 } 
	gkmem
;

27 
	$köô
()

29 
	`öôlock
(&
kmem
.
lock
, "kmem");

30 
	`‰ìønge
(
íd
, (*)
PHYSTOP
);

31 
	}
}

34 
	$‰ìønge
(*
∑_°¨t
, *
∑_íd
)

36 *
p
;

37 
p
 = (*)
	`PGROUNDUP
((
uöt64
)
∑_°¨t
);

38 ; 
p
 + 
PGSIZE
 <(*)
∑_íd
;Ö += PGSIZE)

39 
	`k‰ì
(
p
);

40 
	}
}

47 
	$k‰ì
(*
∑
)

49 
run
 *
r
;

51 if(((
uöt64
)
∑
 % 
PGSIZE
Ë!0 || (*Ì®< 
íd
 || (uöt64Ì®>
PHYSTOP
)

52 
	`∑nic
("kfree");

55 
	`mem£t
(
∑
, 1, 
PGSIZE
);

57 
r
 = (
run
*)
∑
;

59 
	`acquúe
(&
kmem
.
lock
);

60 
r
->
√xt
 = 
kmem
.
‰ìli°
;

61 
kmem
.
‰ìli°
 = 
r
;

62 
	`ªÀa£
(&
kmem
.
lock
);

63 
	}
}

69 
	$kÆloc
()

71 
run
 *
r
;

73 
	`acquúe
(&
kmem
.
lock
);

74 
r
 = 
kmem
.
‰ìli°
;

75 if(
r
)

76 
kmem
.
‰ìli°
 = 
r
->
√xt
;

77 
	`ªÀa£
(&
kmem
.
lock
);

78 if(
r
)

79 
	`mem£t
((*)
r
, 5, 
PGSIZE
);

80  (*)
r
;

81 
	}
}

	@log.c

1 
	~"ty≥s.h
"

2 
	~"riscv.h
"

3 
	~"defs.h
"

4 
	~"∑øm.h
"

5 
	~"•ölock.h
"

6 
	~"¶ì∂ock.h
"

7 
	~"fs.h
"

8 
	~"buf.h
"

35 
	sloghódî
 {

36 
	mn
;

37 
	mblock
[
LOGSIZE
];

40 
	slog
 {

41 
•ölock
 
	mlock
;

42 
	m°¨t
;

43 
	msize
;

44 
	mout°™dög
;

45 
	mcommôtög
;

46 
	mdev
;

47 
loghódî
 
	mlh
;

49 
log
 
	glog
;

51 
ªcovî_‰om_log
();

52 
commô
();

55 
	$öôlog
(
dev
, 
su≥rblock
 *
sb
)

57 i‡((
loghódî
Ë>
BSIZE
)

58 
	`∑nic
("initlog:Åoo bigÜogheader");

60 
	`öôlock
(&
log
.
lock
, "log");

61 
log
.
°¨t
 = 
sb
->
log°¨t
;

62 
log
.
size
 = 
sb
->
∆og
;

63 
log
.
dev
 = dev;

64 
	`ªcovî_‰om_log
();

65 
	}
}

69 
	$ö°Æl_å™s
()

71 
èû
;

73 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++) {

74 
buf
 *
lbuf
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
+
èû
+1);

75 
buf
 *
dbuf
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

76 
	`memmove
(
dbuf
->
d©a
, 
lbuf
->d©a, 
BSIZE
);

77 
	`bwrôe
(
dbuf
);

78 
	`bu≈ö
(
dbuf
);

79 
	`bªl£
(
lbuf
);

80 
	`bªl£
(
dbuf
);

82 
	}
}

86 
	$ªad_hód
()

88 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

89 
loghódî
 *
lh
 = (loghódî *Ë(
buf
->
d©a
);

90 
i
;

91 
log
.
lh
.
n
 =Üh->n;

92 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

93 
log
.
lh
.
block
[
i
] =Üh->block[i];

95 
	`bªl£
(
buf
);

96 
	}
}

102 
	$wrôe_hód
()

104 
buf
 *bu‡
	`bªad
(
log
.
dev
,Üog.
°¨t
);

105 
loghódî
 *
hb
 = (loghódî *Ë(
buf
->
d©a
);

106 
i
;

107 
hb
->
n
 = 
log
.
lh
.n;

108 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

109 
hb
->
block
[
i
] = 
log
.
lh
.block[i];

111 
	`bwrôe
(
buf
);

112 
	`bªl£
(
buf
);

113 
	}
}

116 
	$ªcovî_‰om_log
()

118 
	`ªad_hód
();

119 
	`ö°Æl_å™s
();

120 
log
.
lh
.
n
 = 0;

121 
	`wrôe_hód
();

122 
	}
}

126 
	$begö_›
()

128 
	`acquúe
(&
log
.
lock
);

130 if(
log
.
commôtög
){

131 
	`¶ìp
(&
log
, &log.
lock
);

132 } if(
log
.
lh
.
n
 + (log.
out°™dög
+1)*
MAXOPBLOCKS
 > 
LOGSIZE
){

134 
	`¶ìp
(&
log
, &log.
lock
);

136 
log
.
out°™dög
 += 1;

137 
	`ªÀa£
(&
log
.
lock
);

141 
	}
}

146 
	$íd_›
()

148 
do_commô
 = 0;

150 
	`acquúe
(&
log
.
lock
);

151 
log
.
out°™dög
 -= 1;

152 if(
log
.
commôtög
)

153 
	`∑nic
("log.committing");

154 if(
log
.
out°™dög
 == 0){

155 
do_commô
 = 1;

156 
log
.
commôtög
 = 1;

161 
	`wakeup
(&
log
);

163 
	`ªÀa£
(&
log
.
lock
);

165 if(
do_commô
){

168 
	`commô
();

169 
	`acquúe
(&
log
.
lock
);

170 
log
.
commôtög
 = 0;

171 
	`wakeup
(&
log
);

172 
	`ªÀa£
(&
log
.
lock
);

174 
	}
}

178 
	$wrôe_log
()

180 
èû
;

182 
èû
 = 0;Åaû < 
log
.
lh
.
n
;Åail++) {

183 
buf
 *
to
 = 
	`bªad
(
log
.
dev
,Üog.
°¨t
+
èû
+1);

184 
buf
 *
‰om
 = 
	`bªad
(
log
.
dev
,Üog.
lh
.
block
[
èû
]);

185 
	`memmove
(
to
->
d©a
, 
‰om
->d©a, 
BSIZE
);

186 
	`bwrôe
(
to
);

187 
	`bªl£
(
‰om
);

188 
	`bªl£
(
to
);

190 
	}
}

193 
	$commô
()

195 i‡(
log
.
lh
.
n
 > 0) {

196 
	`wrôe_log
();

197 
	`wrôe_hód
();

198 
	`ö°Æl_å™s
();

199 
log
.
lh
.
n
 = 0;

200 
	`wrôe_hód
();

202 
	}
}

214 
	$log_wrôe
(
buf
 *
b
)

216 
i
;

218 i‡(
log
.
lh
.
n
 >
LOGSIZE
 ||Üog.lh.¿>log.
size
 - 1)

219 
	`∑nic
("too bigáÅransaction");

220 i‡(
log
.
out°™dög
 < 1)

221 
	`∑nic
("log_write outside ofÅrans");

223 
	`acquúe
(&
log
.
lock
);

224 
i
 = 0; i < 
log
.
lh
.
n
; i++) {

225 i‡(
log
.
lh
.
block
[
i
] =
b
->
blockno
)

228 
log
.
lh
.
block
[
i
] = 
b
->
blockno
;

229 i‡(
i
 =
log
.
lh
.
n
) {

230 
	`bpö
(
b
);

231 
log
.
lh
.
n
++;

233 
	`ªÀa£
(&
log
.
lock
);

234 
	}
}

	@main.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"defs.h
"

7 vﬁ©ûê
	g°¨ãd
 = 0;

11 
	$maö
()

13 if(
	`˝uid
() == 0){

14 
	`c⁄sﬁeöô
();

15 #i‡
	`deföed
(
LAB_PGTBL
Ë|| deföed(
LAB_LOCK
)

16 
	`°©söô
();

18 
	`¥ötföô
();

19 
	`¥ötf
("\n");

20 
	`¥ötf
("xv6 kernel is booting\n");

21 
	`¥ötf
("\n");

22 
	`köô
();

23 
	`kvmöô
();

24 
	`kvmöôh¨t
();

25 
	`¥ocöô
();

26 
	`å≠öô
();

27 
	`å≠öôh¨t
();

28 
	`∂icöô
();

29 
	`∂icöôh¨t
();

30 
	`böô
();

31 
	`iöô
();

32 
	`fûeöô
();

33 
	`vútio_disk_öô
();

34 #ifde‡
LAB_NET


35 
	`pci_öô
();

36 
	`socköô
();

38 
	`u£röô
();

39 
	`__sync_synchr⁄ize
();

40 
°¨ãd
 = 1;

42 
°¨ãd
 == 0)

44 
	`__sync_synchr⁄ize
();

45 
	`¥ötf
("h¨à%d sèπög\n", 
	`˝uid
());

46 
	`kvmöôh¨t
();

47 
	`å≠öôh¨t
();

48 
	`∂icöôh¨t
();

51 
	`scheduÀr
();

52 
	}
}

	@memlayout.h

21 
	#UART0
 0x10000000L

	)

22 
	#UART0_IRQ
 10

	)

25 
	#VIRTIO0
 0x10001000

	)

26 
	#VIRTIO0_IRQ
 1

	)

29 
	#CLINT
 0x2000000L

	)

30 
	#CLINT_MTIMECMP
(
h¨tid
Ë(
CLINT
 + 0x4000 + 8*(h¨tid))

	)

31 
	#CLINT_MTIME
 (
CLINT
 + 0xBFF8)

32 

	)

34 
	#PLIC
 0x0c000000L

	)

35 
	#PLIC_PRIORITY
 (
PLIC
 + 0x0)

	)

36 
	#PLIC_PENDING
 (
PLIC
 + 0x1000)

	)

37 
	#PLIC_MENABLE
(
h¨t
Ë(
PLIC
 + 0x2000 + (h¨t)*0x100)

	)

38 
	#PLIC_SENABLE
(
h¨t
Ë(
PLIC
 + 0x2080 + (h¨t)*0x100)

	)

39 
	#PLIC_MPRIORITY
(
h¨t
Ë(
PLIC
 + 0x200000 + (h¨t)*0x2000)

	)

40 
	#PLIC_SPRIORITY
(
h¨t
Ë(
PLIC
 + 0x201000 + (h¨t)*0x2000)

	)

41 
	#PLIC_MCLAIM
(
h¨t
Ë(
PLIC
 + 0x200004 + (h¨t)*0x2000)

	)

42 
	#PLIC_SCLAIM
(
h¨t
Ë(
PLIC
 + 0x201004 + (h¨t)*0x2000)

	)

47 
	#KERNBASE
 0x80000000L

	)

48 
	#PHYSTOP
 (
KERNBASE
 + 128*1024*1024)

	)

52 
	#TRAMPOLINE
 (
MAXVA
 - 
PGSIZE
)

	)

56 
	#KSTACK
(
p
Ë(
TRAMPOLINE
 - (’)+1)* 2*
PGSIZE
)

	)

67 
	#TRAPFRAME
 (
TRAMPOLINE
 - 
PGSIZE
)

	)

	@param.h

1 
	#NPROC
 64

2 
	#NCPU
 8

3 
	#NOFILE
 16

4 
	#NFILE
 100

5 
	#NINODE
 50

6 
	#NDEV
 10

7 
	#ROOTDEV
 1

8 
	#MAXARG
 32

9 
	#MAXOPBLOCKS
 10

10 
	#LOGSIZE
 (
MAXOPBLOCKS
*3)

11 
	#NBUF
 (
MAXOPBLOCKS
*3)

12 
	#FSSIZE
 1000

13 
	#MAXPATH
 128

	@pipe.c

1 
	~"ty≥s.h
"

2 
	~"riscv.h
"

3 
	~"defs.h
"

4 
	~"∑øm.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

7 
	~"fs.h
"

8 
	~"¶ì∂ock.h
"

9 
	~"fûe.h
"

11 
	#PIPESIZE
 512

	)

13 
	spùe
 {

14 
•ölock
 
	mlock
;

15 
	md©a
[
PIPESIZE
];

16 
uöt
 
	mƒód
;

17 
uöt
 
	mnwrôe
;

18 
	mªad›í
;

19 
	mwrôe›í
;

23 
	$pùóŒoc
(
fûe
 **
f0
, fûê**
f1
)

25 
pùe
 *
pi
;

27 
pi
 = 0;

28 *
f0
 = *
f1
 = 0;

29 if((*
f0
 = 
	`fûóŒoc
()Ë=0 || (*
f1
 = filealloc()) == 0)

30 
bad
;

31 if((
pi
 = (
pùe
*)
	`kÆloc
()) == 0)

32 
bad
;

33 
pi
->
ªad›í
 = 1;

34 
pi
->
wrôe›í
 = 1;

35 
pi
->
nwrôe
 = 0;

36 
pi
->
ƒód
 = 0;

37 
	`öôlock
(&
pi
->
lock
, "pipe");

38 (*
f0
)->
ty≥
 = 
FD_PIPE
;

39 (*
f0
)->
ªadabÀ
 = 1;

40 (*
f0
)->
wrôabÀ
 = 0;

41 (*
f0
)->
pùe
 = 
pi
;

42 (*
f1
)->
ty≥
 = 
FD_PIPE
;

43 (*
f1
)->
ªadabÀ
 = 0;

44 (*
f1
)->
wrôabÀ
 = 1;

45 (*
f1
)->
pùe
 = 
pi
;

48 
bad
:

49 if(
pi
)

50 
	`k‰ì
((*)
pi
);

51 if(*
f0
)

52 
	`fûe˛o£
(*
f0
);

53 if(*
f1
)

54 
	`fûe˛o£
(*
f1
);

56 
	}
}

59 
	$pùe˛o£
(
pùe
 *
pi
, 
wrôabÀ
)

61 
	`acquúe
(&
pi
->
lock
);

62 if(
wrôabÀ
){

63 
pi
->
wrôe›í
 = 0;

64 
	`wakeup
(&
pi
->
ƒód
);

66 
pi
->
ªad›í
 = 0;

67 
	`wakeup
(&
pi
->
nwrôe
);

69 if(
pi
->
ªad›í
 =0 &&Öi->
wrôe›í
 == 0){

70 
	`ªÀa£
(&
pi
->
lock
);

71 
	`k‰ì
((*)
pi
);

73 
	`ªÀa£
(&
pi
->
lock
);

74 
	}
}

77 
	$pùewrôe
(
pùe
 *
pi
, 
uöt64
 
addr
, 
n
)

79 
i
;

80 
ch
;

81 
¥oc
 *
¥
 = 
	`my¥oc
();

83 
	`acquúe
(&
pi
->
lock
);

84 
i
 = 0; i < 
n
; i++){

85 
pi
->
nwrôe
 =pi->
ƒód
 + 
PIPESIZE
){

86 if(
pi
->
ªad›í
 =0 || 
¥
->
kûÀd
){

87 
	`ªÀa£
(&
pi
->
lock
);

90 
	`wakeup
(&
pi
->
ƒód
);

91 
	`¶ìp
(&
pi
->
nwrôe
, &pi->
lock
);

93 if(
	`c›yö
(
¥
->
∑gëabÀ
, &
ch
, 
addr
 + 
i
, 1) == -1)

95 
pi
->
d©a
[pi->
nwrôe
++ % 
PIPESIZE
] = 
ch
;

97 
	`wakeup
(&
pi
->
ƒód
);

98 
	`ªÀa£
(&
pi
->
lock
);

99  
i
;

100 
	}
}

103 
	$pùîód
(
pùe
 *
pi
, 
uöt64
 
addr
, 
n
)

105 
i
;

106 
¥oc
 *
¥
 = 
	`my¥oc
();

107 
ch
;

109 
	`acquúe
(&
pi
->
lock
);

110 
pi
->
ƒód
 =pi->
nwrôe
 &&Öi->
wrôe›í
){

111 if(
¥
->
kûÀd
){

112 
	`ªÀa£
(&
pi
->
lock
);

115 
	`¶ìp
(&
pi
->
ƒód
, &pi->
lock
);

117 
i
 = 0; i < 
n
; i++){

118 if(
pi
->
ƒód
 =pi->
nwrôe
)

120 
ch
 = 
pi
->
d©a
[pi->
ƒód
++ % 
PIPESIZE
];

121 if(
	`c›yout
(
¥
->
∑gëabÀ
, 
addr
 + 
i
, &
ch
, 1) == -1)

124 
	`wakeup
(&
pi
->
nwrôe
);

125 
	`ªÀa£
(&
pi
->
lock
);

126  
i
;

127 
	}
}

	@plic.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"defs.h
"

12 
	$∂icöô
()

15 *(
uöt32
*)(
PLIC
 + 
UART0_IRQ
*4) = 1;

16 *(
uöt32
*)(
PLIC
 + 
VIRTIO0_IRQ
*4) = 1;

17 
	}
}

20 
	$∂icöôh¨t
()

22 
h¨t
 = 
	`˝uid
();

25 *(
uöt32
*)
	`PLIC_SENABLE
(
h¨t
)(1 << 
UART0_IRQ
Ë| (1 << 
VIRTIO0_IRQ
);

28 *(
uöt32
*)
	`PLIC_SPRIORITY
(
h¨t
) = 0;

29 
	}
}

33 
	$∂ic_˛aim
()

35 
h¨t
 = 
	`˝uid
();

36 
úq
 = *(
uöt32
*)
	`PLIC_SCLAIM
(
h¨t
);

37  
úq
;

38 
	}
}

42 
	$∂ic_com∂ëe
(
úq
)

44 
h¨t
 = 
	`˝uid
();

45 *(
uöt32
*)
	`PLIC_SCLAIM
(
h¨t
Ë
úq
;

46 
	}
}

	@printf.c

5 
	~<°d¨g.h
>

7 
	~"ty≥s.h
"

8 
	~"∑øm.h
"

9 
	~"•ölock.h
"

10 
	~"¶ì∂ock.h
"

11 
	~"fs.h
"

12 
	~"fûe.h
"

13 
	~"memœyout.h
"

14 
	~"riscv.h
"

15 
	~"defs.h
"

16 
	~"¥oc.h
"

18 vﬁ©ûê
	g∑nicked
 = 0;

22 
•ölock
 
	mlock
;

23 
	mlockög
;

24 } 
	g¥
;

26 
	gdigôs
[] = "0123456789abcdef";

29 
	$¥ötöt
(
xx
, 
ba£
, 
sign
)

31 
buf
[16];

32 
i
;

33 
uöt
 
x
;

35 if(
sign
 && (sig¿
xx
 < 0))

36 
x
 = -
xx
;

38 
x
 = 
xx
;

40 
i
 = 0;

42 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

43 } (
x
 /
ba£
) != 0);

45 if(
sign
)

46 
buf
[
i
++] = '-';

48 --
i
 >= 0)

49 
	`c⁄•utc
(
buf
[
i
]);

50 
	}
}

53 
	$¥öçå
(
uöt64
 
x
)

55 
i
;

56 
	`c⁄•utc
('0');

57 
	`c⁄•utc
('x');

58 
i
 = 0; i < ((
uöt64
Ë* 2); i++, 
x
 <<= 4)

59 
	`c⁄•utc
(
digôs
[
x
 >> ((
uöt64
) * 8 - 4)]);

60 
	}
}

64 
	$¥ötf
(*
fmt
, ...)

66 
va_li°
 
≠
;

67 
i
, 
c
, 
lockög
;

68 *
s
;

70 
lockög
 = 
¥
.locking;

71 if(
lockög
)

72 
	`acquúe
(&
¥
.
lock
);

74 i‡(
fmt
 == 0)

75 
	`∑nic
("null fmt");

77 
	`va_°¨t
(
≠
, 
fmt
);

78 
i
 = 0; (
c
 = 
fmt
[i] & 0xff) != 0; i++){

79 if(
c
 != '%'){

80 
	`c⁄•utc
(
c
);

83 
c
 = 
fmt
[++
i
] & 0xff;

84 if(
c
 == 0)

86 
c
){

88 
	`¥ötöt
(
	`va_¨g
(
≠
, ), 10, 1);

91 
	`¥ötöt
(
	`va_¨g
(
≠
, ), 16, 1);

94 
	`¥öçå
(
	`va_¨g
(
≠
, 
uöt64
));

97 if((
s
 = 
	`va_¨g
(
≠
, *)) == 0)

98 
s
 = "(null)";

99 ; *
s
; s++)

100 
	`c⁄•utc
(*
s
);

103 
	`c⁄•utc
('%');

107 
	`c⁄•utc
('%');

108 
	`c⁄•utc
(
c
);

113 if(
lockög
)

114 
	`ªÀa£
(&
¥
.
lock
);

115 
	}
}

118 
	$∑nic
(*
s
)

120 
¥
.
lockög
 = 0;

121 
	`¥ötf
("panic: ");

122 
	`¥ötf
(
s
);

123 
	`¥ötf
("\n");

124 
∑nicked
 = 1;

127 
	}
}

130 
	$¥ötföô
()

132 
	`öôlock
(&
¥
.
lock
, "pr");

133 
¥
.
lockög
 = 1;

134 
	}
}

	@proc.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

7 
	~"defs.h
"

9 
˝u
 
	g˝us
[
NCPU
];

11 
¥oc
 
	g¥oc
[
NPROC
];

13 
¥oc
 *
	göô¥oc
;

15 
	g√xçid
 = 1;

16 
•ölock
 
	gpid_lock
;

18 
f‹kªt
();

19 
wakeup1
(
¥oc
 *
ch™
);

20 
‰ì¥oc
(
¥oc
 *
p
);

22 
åampﬁöe
[];

26 
	$¥ocöô
()

28 
¥oc
 *
p
;

30 
	`öôlock
(&
pid_lock
, "nextpid");

31 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++) {

32 
	`öôlock
(&
p
->
lock
, "proc");

37 
	`kvmöôh¨t
();

38 
	}
}

44 
	$˝uid
()

46 
id
 = 
	`r_ç
();

47  
id
;

48 
	}
}

52 
˝u
*

53 
	$my˝u
() {

54 
id
 = 
	`˝uid
();

55 
˝u
 *
c
 = &
˝us
[
id
];

56  
c
;

57 
	}
}

60 
¥oc
*

61 
	$my¥oc
() {

62 
	`push_off
();

63 
˝u
 *
c
 = 
	`my˝u
();

64 
¥oc
 *
p
 = 
c
->proc;

65 
	`p›_off
();

66  
p
;

67 
	}
}

70 
	$Ælo˝id
() {

71 
pid
;

73 
	`acquúe
(&
pid_lock
);

74 
pid
 = 
√xçid
;

75 
√xçid
 =Çextpid + 1;

76 
	`ªÀa£
(&
pid_lock
);

78  
pid
;

79 
	}
}

85 
¥oc
*

86 
	$Ælo˝roc
()

89 
¥oc
 *
p
;

91 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++) {

92 
	`acquúe
(&
p
->
lock
);

93 if(
p
->
°©e
 =
UNUSED
) {

94 
found
;

96 
	`ªÀa£
(&
p
->
lock
);

101 
found
:

102 
p
->
pid
 = 
	`Ælo˝id
();

105 if((
p
->
å≠‰ame
 = (å≠‰amê*)
	`kÆloc
()) == 0){

106 
	`ªÀa£
(&
p
->
lock
);

111 
p
->
∑gëabÀ
 = 
	`¥oc_∑gëabÀ
(p);

112 if(
p
->
∑gëabÀ
 == 0){

113 
	`‰ì¥oc
(
p
);

114 
	`ªÀa£
(&
p
->
lock
);

117 
p
->
k∑gëabÀ
 = 
	`u£r_kvm¸óã
();

118 *
∑
 = 
	`kÆloc
();

119 if(
∑
 == 0)

120 
	`∑nic
("kalloc");

121 
uöt64
 
va
 = 
	`KSTACK
(0);

122 
	`u£r_kvmm≠
(
p
->
k∑gëabÀ
,
va
,
PGSIZE
,(
uöt64
)
∑
,
PTE_R
 | 
PTE_W
);

123 
p
->
k°ack
 = 
	`KSTACK
(0);

126 
	`mem£t
(&
p
->
c⁄ãxt
, 0, (p->context));

127 
p
->
c⁄ãxt
.
ø
 = (
uöt64
)
f‹kªt
;

128 
p
->
c⁄ãxt
.
•
 =Ö->
k°ack
 + 
PGSIZE
;

131  
p
;

132 
	}
}

138 
	$‰ì¥oc
(
¥oc
 *
p
)

141 if(
p
->
å≠‰ame
)

142 
	`k‰ì
((*)
p
->
å≠‰ame
);

143 
p
->
å≠‰ame
 = 0;

144 if(
p
->
k°ack
){

145 
	`k‰ì
((*)
	`PTE2PA
(*
	`wÆk
(
p
->
k∑gëabÀ
,
	`KSTACK
(0),0)));

146 
p
->
k°ack
 = 0;

148 if(
p
->
k∑gëabÀ
)

149 
	`u£r_kvm‰ì
(
p
->
k∑gëabÀ
);

150 if(
p
->
∑gëabÀ
)

151 
	`¥oc_‰ì∑gëabÀ
(
p
->
∑gëabÀ
,Ö->
sz
);

152 
p
->
∑gëabÀ
 = 0;

153 
p
->
k∑gëabÀ
 = 0;

154 
p
->
sz
 = 0;

155 
p
->
pid
 = 0;

156 
p
->
∑ª¡
 = 0;

157 
p
->
«me
[0] = 0;

158 
p
->
ch™
 = 0;

159 
p
->
kûÀd
 = 0;

160 
p
->
x°©e
 = 0;

161 
p
->
°©e
 = 
UNUSED
;

162 
	}
}

166 
∑gëabÀ_t


167 
	$¥oc_∑gëabÀ
(
¥oc
 *
p
)

169 
∑gëabÀ_t
 
∑gëabÀ
;

172 
∑gëabÀ
 = 
	`uvm¸óã
();

173 if(
∑gëabÀ
 == 0)

180 if(
	`m≠∑ges
(
∑gëabÀ
, 
TRAMPOLINE
, 
PGSIZE
,

181 (
uöt64
)
åampﬁöe
, 
PTE_R
 | 
PTE_X
) < 0){

182 
	`uvm‰ì
(
∑gëabÀ
, 0);

187 if(
	`m≠∑ges
(
∑gëabÀ
, 
TRAPFRAME
, 
PGSIZE
,

188 (
uöt64
)(
p
->
å≠‰ame
), 
PTE_R
 | 
PTE_W
) < 0){

189 
	`uvmunm≠
(
∑gëabÀ
, 
TRAMPOLINE
, 1, 0);

190 
	`uvm‰ì
(
∑gëabÀ
, 0);

194  
∑gëabÀ
;

195 
	}
}

200 
	$¥oc_‰ì∑gëabÀ
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
sz
)

202 
	`uvmunm≠
(
∑gëabÀ
, 
TRAMPOLINE
, 1, 0);

203 
	`uvmunm≠
(
∑gëabÀ
, 
TRAPFRAME
, 1, 0);

204 
	`uvm‰ì
(
∑gëabÀ
, 
sz
);

205 
	}
}

209 
uch¨
 
	göôcode
[] = {

221 
	$u£röô
()

223 
¥oc
 *
p
;

225 
p
 = 
	`Ælo˝roc
();

226 
öô¥oc
 = 
p
;

230 
	`uvmöô
(
p
->
∑gëabÀ
, 
öôcode
, (initcode));

231 
	`kvmc›y
(
p
->
∑gëabÀ
,Ö->
k∑gëabÀ
,0, (
öôcode
));

233 
p
->
sz
 = 
PGSIZE
;

236 
p
->
å≠‰ame
->
ïc
 = 0;

237 
p
->
å≠‰ame
->
•
 = 
PGSIZE
;

239 
	`ß„°r˝y
(
p
->
«me
, "initcode", (p->name));

240 
p
->
cwd
 = 
	`«mei
("/");

242 
p
->
°©e
 = 
RUNNABLE
;

244 
	`ªÀa£
(&
p
->
lock
);

245 
	}
}

250 
	$grow¥oc
(
n
)

252 
uöt
 
sz
,
sz1
;

253 
¥oc
 *
p
 = 
	`my¥oc
();

255 
sz
 = 
p
->sz;

256 
sz1
 = 
sz
;

264 if(
n
 > 0){

265 if((
sz
 = 
	`uvmÆloc
(
p
->
∑gëabÀ
, 
sz1
, sz1 + 
n
)) == 0) {

268 
	`kvmc›y
(
p
->
∑gëabÀ
,p->
k∑gëabÀ
,
sz1
,sz1 + 
n
);

269 } if(
n
 < 0){

270 
sz
 = 
	`uvmdóŒoc
(
p
->
∑gëabÀ
, 
sz1
, sz1 + 
n
);

271 
	`kvmdóŒoc
(
p
->
k∑gëabÀ
, 
sz1
, sz1 + 
n
);

273 
p
->
sz
 = sz;

279 
	}
}

284 
	$f‹k
()

287 
i
, 
pid
;

288 
¥oc
 *
≈
;

289 
¥oc
 *
p
 = 
	`my¥oc
();

292 if((
≈
 = 
	`Ælo˝roc
()) == 0){

297 if(
	`uvmc›y
(
p
->
∑gëabÀ
, 
≈
->∑gëabÀ,Ö->
sz
) < 0){

298 
	`‰ì¥oc
(
≈
);

299 
	`ªÀa£
(&
≈
->
lock
);

302 if(
	`kvmc›y
(
≈
->
∑gëabÀ
,Çp->
k∑gëabÀ
,0, 
p
->
sz
) < 0){

303 
	`‰ì¥oc
(
≈
);

304 
	`ªÀa£
(&
≈
->
lock
);

309 
≈
->
sz
 = 
p
->sz;

311 
≈
->
∑ª¡
 = 
p
;

314 *(
≈
->
å≠‰ame
Ë*(
p
->trapframe);

317 
≈
->
å≠‰ame
->
a0
 = 0;

320 
i
 = 0; i < 
NOFILE
; i++)

321 if(
p
->
ofûe
[
i
])

322 
≈
->
ofûe
[
i
] = 
	`fûedup
(
p
->ofile[i]);

323 
≈
->
cwd
 = 
	`idup
(
p
->cwd);

325 
	`ß„°r˝y
(
≈
->
«me
, 
p
->name, (p->name));

327 
pid
 = 
≈
->pid;

329 
≈
->
°©e
 = 
RUNNABLE
;

331 
	`ªÀa£
(&
≈
->
lock
);

337  
pid
;

338 
	}
}

343 
	$ª∑ª¡
(
¥oc
 *
p
)

345 
¥oc
 *
µ
;

347 
µ
 = 
¥oc
;Ö∞< &¥oc[
NPROC
];Öp++){

352 if(
µ
->
∑ª¡
 =
p
){

355 
	`acquúe
(&
µ
->
lock
);

356 
µ
->
∑ª¡
 = 
öô¥oc
;

361 
	`ªÀa£
(&
µ
->
lock
);

364 
	}
}

370 
	$exô
(
°©us
)

373 
¥oc
 *
p
 = 
	`my¥oc
();

375 if(
p
 =
öô¥oc
)

376 
	`∑nic
("initÉxiting");

379 
fd
 = 0; fd < 
NOFILE
; fd++){

380 if(
p
->
ofûe
[
fd
]){

381 
fûe
 *
f
 = 
p
->
ofûe
[
fd
];

382 
	`fûe˛o£
(
f
);

383 
p
->
ofûe
[
fd
] = 0;

387 
	`begö_›
();

388 
	`ùut
(
p
->
cwd
);

389 
	`íd_›
();

390 
p
->
cwd
 = 0;

397 
	`acquúe
(&
öô¥oc
->
lock
);

398 
	`wakeup1
(
öô¥oc
);

399 
	`ªÀa£
(&
öô¥oc
->
lock
);

407 
	`acquúe
(&
p
->
lock
);

408 
¥oc
 *
‹igöÆ_∑ª¡
 = 
p
->
∑ª¡
;

409 
	`ªÀa£
(&
p
->
lock
);

413 
	`acquúe
(&
‹igöÆ_∑ª¡
->
lock
);

415 
	`acquúe
(&
p
->
lock
);

418 
	`ª∑ª¡
(
p
);

421 
	`wakeup1
(
‹igöÆ_∑ª¡
);

423 
p
->
x°©e
 = 
°©us
;

424 
p
->
°©e
 = 
ZOMBIE
;

426 
	`ªÀa£
(&
‹igöÆ_∑ª¡
->
lock
);

429 
	`sched
();

430 
	`∑nic
("zombieÉxit");

431 
	}
}

436 
	$waô
(
uöt64
 
addr
)

438 
¥oc
 *
≈
;

439 
havekids
, 
pid
;

440 
¥oc
 *
p
 = 
	`my¥oc
();

444 
	`acquúe
(&
p
->
lock
);

448 
havekids
 = 0;

449 
≈
 = 
¥oc
;Ç∞< &¥oc[
NPROC
];Çp++){

453 if(
≈
->
∑ª¡
 =
p
){

456 
	`acquúe
(&
≈
->
lock
);

457 
havekids
 = 1;

458 if(
≈
->
°©e
 =
ZOMBIE
){

460 
pid
 = 
≈
->pid;

461 if(
addr
 !0 && 
	`c›yout
(
p
->
∑gëabÀ
,áddr, (*)&
≈
->
x°©e
,

462 (
≈
->
x°©e
)) < 0) {

463 
	`ªÀa£
(&
≈
->
lock
);

464 
	`ªÀa£
(&
p
->
lock
);

467 
	`‰ì¥oc
(
≈
);

468 
	`ªÀa£
(&
≈
->
lock
);

469 
	`ªÀa£
(&
p
->
lock
);

470  
pid
;

472 
	`ªÀa£
(&
≈
->
lock
);

477 if(!
havekids
 || 
p
->
kûÀd
){

478 
	`ªÀa£
(&
p
->
lock
);

483 
	`¶ìp
(
p
, &p->
lock
);

485 
	}
}

495 
	$scheduÀr
()

497 
¥oc
 *
p
;

498 
˝u
 *
c
 = 
	`my˝u
();

500 
c
->
¥oc
 = 0;

503 
	`öå_⁄
();

505 
found
 = 0;

506 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++) {

507 
	`acquúe
(&
p
->
lock
);

508 if(
p
->
°©e
 =
RUNNABLE
) {

512 
p
->
°©e
 = 
RUNNING
;

513 
c
->
¥oc
 = 
p
;

514 
	`w_ßç
(
	`MAKE_SATP
(
p
->
k∑gëabÀ
));

515 
	`s„n˚_vma
();

516 
	`swtch
(&
c
->
c⁄ãxt
, &
p
->context);

517 
	`kvmöôh¨t
();

520 
c
->
¥oc
 = 0;

522 
found
 = 1;

524 
	`ªÀa£
(&
p
->
lock
);

526 #i‡!
	`deföed
 (
LAB_FS
)

527 if(
found
 == 0) {

528 
	`öå_⁄
();

529 
	`kvmöôh¨t
();

530 
asm
 volatile("wfi");

536 
	}
}

546 
	$sched
()

548 
öã«
;

549 
¥oc
 *
p
 = 
	`my¥oc
();

551 if(!
	`hﬁdög
(&
p
->
lock
))

552 
	`∑nic
("schedÖ->lock");

553 if(
	`my˝u
()->
noff
 != 1)

554 
	`∑nic
("schedÜocks");

555 if(
p
->
°©e
 =
RUNNING
)

556 
	`∑nic
("schedÑunning");

557 if(
	`öå_gë
())

558 
	`∑nic
("sched interruptible");

560 
öã«
 = 
	`my˝u
()->intena;

561 
	`swtch
(&
p
->
c⁄ãxt
, &
	`my˝u
()->context);

562 
	`my˝u
()->
öã«
 = intena;

563 
	}
}

567 
	$yõld
()

569 
¥oc
 *
p
 = 
	`my¥oc
();

570 
	`acquúe
(&
p
->
lock
);

571 
p
->
°©e
 = 
RUNNABLE
;

572 
	`sched
();

573 
	`ªÀa£
(&
p
->
lock
);

574 
	}
}

579 
	$f‹kªt
()

581 
fú°
 = 1;

584 
	`ªÀa£
(&
	`my¥oc
()->
lock
);

586 i‡(
fú°
) {

590 
fú°
 = 0;

591 
	`fsöô
(
ROOTDEV
);

594 
	`u£πø¥ë
();

595 
	}
}

600 
	$¶ìp
(*
ch™
, 
•ölock
 *
lk
)

602 
¥oc
 *
p
 = 
	`my¥oc
();

610 if(
lk
 !&
p
->
lock
){

611 
	`acquúe
(&
p
->
lock
);

612 
	`ªÀa£
(
lk
);

616 
p
->
ch™
 = chan;

617 
p
->
°©e
 = 
SLEEPING
;

619 
	`sched
();

622 
p
->
ch™
 = 0;

625 if(
lk
 !&
p
->
lock
){

626 
	`ªÀa£
(&
p
->
lock
);

627 
	`acquúe
(
lk
);

629 
	}
}

634 
	$wakeup
(*
ch™
)

636 
¥oc
 *
p
;

638 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++) {

639 
	`acquúe
(&
p
->
lock
);

640 if(
p
->
°©e
 =
SLEEPING
 &&Ö->
ch™
 == chan) {

641 
p
->
°©e
 = 
RUNNABLE
;

643 
	`ªÀa£
(&
p
->
lock
);

645 
	}
}

650 
	$wakeup1
(
¥oc
 *
p
)

652 if(!
	`hﬁdög
(&
p
->
lock
))

653 
	`∑nic
("wakeup1");

654 if(
p
->
ch™
 =∞&&Ö->
°©e
 =
SLEEPING
) {

655 
p
->
°©e
 = 
RUNNABLE
;

657 
	}
}

663 
	$kûl
(
pid
)

665 
¥oc
 *
p
;

667 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++){

668 
	`acquúe
(&
p
->
lock
);

669 if(
p
->
pid
 ==Öid){

670 
p
->
kûÀd
 = 1;

671 if(
p
->
°©e
 =
SLEEPING
){

673 
p
->
°©e
 = 
RUNNABLE
;

675 
	`ªÀa£
(&
p
->
lock
);

678 
	`ªÀa£
(&
p
->
lock
);

681 
	}
}

687 
	$eôhî_c›yout
(
u£r_d°
, 
uöt64
 
d°
, *
§c
, uöt64 
Àn
)

689 
¥oc
 *
p
 = 
	`my¥oc
();

690 if(
u£r_d°
){

691  
	`c›yout
(
p
->
∑gëabÀ
, 
d°
, 
§c
, 
Àn
);

693 
	`memmove
((*)
d°
, 
§c
, 
Àn
);

696 
	}
}

702 
	$eôhî_c›yö
(*
d°
, 
u£r_§c
, 
uöt64
 
§c
, uöt64 
Àn
)

704 
¥oc
 *
p
 = 
	`my¥oc
();

705 if(
u£r_§c
){

706  
	`c›yö
(
p
->
∑gëabÀ
, 
d°
, 
§c
, 
Àn
);

708 
	`memmove
(
d°
, (*)
§c
, 
Àn
);

711 
	}
}

717 
	$¥ocdump
()

719 *
°©es
[] = {

720 [
UNUSED
] "unused",

721 [
SLEEPING
] "sleep ",

722 [
RUNNABLE
] "runble",

723 [
RUNNING
] "run ",

724 [
ZOMBIE
] "zombie"

726 
¥oc
 *
p
;

727 *
°©e
;

729 
	`¥ötf
("\n");

730 
p
 = 
¥oc
;Ö < &¥oc[
NPROC
];Ö++){

731 if(
p
->
°©e
 =
UNUSED
)

733 if(
p
->
°©e
 >0 &&Ö->°©ê< 
	`NELEM
(
°©es
) && states[p->state])

734 
°©e
 = 
°©es
[
p
->state];

736 
°©e
 = "???";

737 
	`¥ötf
("%d %†%s", 
p
->
pid
, 
°©e
,Ö->
«me
);

738 
	`¥ötf
("\n");

740 
	}
}

	@proc.h

2 
	sc⁄ãxt
 {

3 
uöt64
 
	mø
;

4 
uöt64
 
	m•
;

7 
uöt64
 
	ms0
;

8 
uöt64
 
	ms1
;

9 
uöt64
 
	ms2
;

10 
uöt64
 
	ms3
;

11 
uöt64
 
	ms4
;

12 
uöt64
 
	ms5
;

13 
uöt64
 
	ms6
;

14 
uöt64
 
	ms7
;

15 
uöt64
 
	ms8
;

16 
uöt64
 
	ms9
;

17 
uöt64
 
	ms10
;

18 
uöt64
 
	ms11
;

22 
	s˝u
 {

23 
¥oc
 *
	m¥oc
;

24 
c⁄ãxt
 
	mc⁄ãxt
;

25 
	mnoff
;

26 
	möã«
;

29 
˝u
 
˝us
[
NCPU
];

44 
	så≠‰ame
 {

45  
uöt64
 
	mkî√l_ßç
;

46  
uöt64
 
	mkî√l_•
;

47  
uöt64
 
	mkî√l_å≠
;

48  
uöt64
 
	mïc
;

49  
uöt64
 
	mkî√l_h¨tid
;

50  
uöt64
 
	mø
;

51  
uöt64
 
	m•
;

52  
uöt64
 
	mgp
;

53  
uöt64
 
	mç
;

54  
uöt64
 
	mt0
;

55  
uöt64
 
	mt1
;

56  
uöt64
 
	mt2
;

57  
uöt64
 
	ms0
;

58  
uöt64
 
	ms1
;

59  
uöt64
 
	ma0
;

60  
uöt64
 
	ma1
;

61  
uöt64
 
	ma2
;

62  
uöt64
 
	ma3
;

63  
uöt64
 
	ma4
;

64  
uöt64
 
	ma5
;

65  
uöt64
 
	ma6
;

66  
uöt64
 
	ma7
;

67  
uöt64
 
	ms2
;

68  
uöt64
 
	ms3
;

69  
uöt64
 
	ms4
;

70  
uöt64
 
	ms5
;

71  
uöt64
 
	ms6
;

72  
uöt64
 
	ms7
;

73  
uöt64
 
	ms8
;

74  
uöt64
 
	ms9
;

75  
uöt64
 
	ms10
;

76  
uöt64
 
	ms11
;

77  
uöt64
 
	mt3
;

78  
uöt64
 
	mt4
;

79  
uöt64
 
	mt5
;

80  
uöt64
 
	mt6
;

83 
	e¥oc°©e
 { 
	mUNUSED
, 
	mSLEEPING
, 
	mRUNNABLE
, 
	mRUNNING
, 
	mZOMBIE
 };

86 
	s¥oc
 {

87 
•ölock
 
	mlock
;

90 
¥oc°©e
 
	m°©e
;

91 
¥oc
 *
	m∑ª¡
;

92 *
	mch™
;

93 
	mkûÀd
;

94 
	mx°©e
;

95 
	mpid
;

98 
uöt64
 
	mk°ack
;

99 
uöt64
 
	msz
;

100 
∑gëabÀ_t
 
	m∑gëabÀ
;

101 
∑gëabÀ_t
 
	mk∑gëabÀ
;

102 
å≠‰ame
 *
	må≠‰ame
;

103 
c⁄ãxt
 
	mc⁄ãxt
;

104 
fûe
 *
	mofûe
[
NOFILE
];

105 
öode
 *
	mcwd
;

106 
	m«me
[16];

	@ramdisk.c

5 
	~"ty≥s.h
"

6 
	~"riscv.h
"

7 
	~"defs.h
"

8 
	~"∑øm.h
"

9 
	~"memœyout.h
"

10 
	~"•ölock.h
"

11 
	~"¶ì∂ock.h
"

12 
	~"fs.h
"

13 
	~"buf.h
"

16 
	$ømdisköô
()

18 
	}
}

23 
	$ømdiskrw
(
buf
 *
b
)

25 if(!
	`hﬁdög¶ìp
(&
b
->
lock
))

26 
	`∑nic
("ramdiskrw: bufÇotÜocked");

27 if((
b
->
Êags
 & (
B_VALID
|
B_DIRTY
)) == B_VALID)

28 
	`∑nic
("ramdiskrw:ÇothingÅo do");

30 if(
b
->
blockno
 >
FSSIZE
)

31 
	`∑nic
("ramdiskrw: blocknoÅoo big");

33 
uöt64
 
diskaddr
 = 
b
->
blockno
 * 
BSIZE
;

34 *
addr
 = (*)
RAMDISK
 + 
diskaddr
;

36 if(
b
->
Êags
 & 
B_DIRTY
){

38 
	`memmove
(
addr
, 
b
->
d©a
, 
BSIZE
);

39 
b
->
Êags
 &~
B_DIRTY
;

42 
	`memmove
(
b
->
d©a
, 
addr
, 
BSIZE
);

43 
b
->
Êags
 |
B_VALID
;

45 
	}
}

	@riscv.h

2 
ölöe
 
uöt64


3 
	$r_mh¨tid
()

5 
uöt64
 
x
;

6 
asm
 vﬁ©ûe("c§∏%0, mh¨tid" : "Ù" (
x
) );

7  
x
;

8 
	}
}

12 
	#MSTATUS_MPP_MASK
 (3L << 11)

13 
	#MSTATUS_MPP_M
 (3L << 11)

	)

14 
	#MSTATUS_MPP_S
 (1L << 11)

	)

15 
	#MSTATUS_MPP_U
 (0L << 11)

	)

16 
	#MSTATUS_MIE
 (1L << 3)

17 

	)

18 
ölöe
 
uöt64


19 
	$r_m°©us
()

21 
uöt64
 
x
;

22 
asm
 vﬁ©ûe("c§∏%0, m°©us" : "Ù" (
x
) );

23  
x
;

24 
	}
}

26 
ölöe
 

27 
	$w_m°©us
(
uöt64
 
x
)

29 
asm
 vﬁ©ûe("c§w m°©us, %0" : : "r" (
x
));

30 
	}
}

35 
ölöe
 

36 
	$w_mïc
(
uöt64
 
x
)

38 
asm
 vﬁ©ûe("c§w mïc, %0" : : "r" (
x
));

39 
	}
}

43 
	#SSTATUS_SPP
 (1L << 8)

44 
	#SSTATUS_SPIE
 (1L << 5)

45 
	#SSTATUS_UPIE
 (1L << 4)

46 
	#SSTATUS_SIE
 (1L << 1)

47 
	#SSTATUS_UIE
 (1L << 0)

48 

	)

49 
ölöe
 
uöt64


50 
	$r_s°©us
()

52 
uöt64
 
x
;

53 
asm
 vﬁ©ûe("c§∏%0, s°©us" : "Ù" (
x
) );

54  
x
;

55 
	}
}

57 
ölöe
 

58 
	$w_s°©us
(
uöt64
 
x
)

60 
asm
 vﬁ©ûe("c§w s°©us, %0" : : "r" (
x
));

61 
	}
}

64 
ölöe
 
uöt64


65 
	$r_sù
()

67 
uöt64
 
x
;

68 
asm
 vﬁ©ûe("c§∏%0, sù" : "Ù" (
x
) );

69  
x
;

70 
	}
}

72 
ölöe
 

73 
	$w_sù
(
uöt64
 
x
)

75 
asm
 vﬁ©ûe("c§w sù, %0" : : "r" (
x
));

76 
	}
}

79 
	#SIE_SEIE
 (1L << 9)

80 
	#SIE_STIE
 (1L << 5)

81 
	#SIE_SSIE
 (1L << 1)

82 
ölöe
 
uöt64


	)

83 
	$r_sõ
()

85 
uöt64
 
x
;

86 
asm
 vﬁ©ûe("c§∏%0, sõ" : "Ù" (
x
) );

87  
x
;

88 
	}
}

90 
ölöe
 

91 
	$w_sõ
(
uöt64
 
x
)

93 
asm
 vﬁ©ûe("c§w sõ, %0" : : "r" (
x
));

94 
	}
}

97 
	#MIE_MEIE
 (1L << 11)

98 
	#MIE_MTIE
 (1L << 7)

99 
	#MIE_MSIE
 (1L << 3)

100 
ölöe
 
uöt64


	)

101 
	$r_mõ
()

103 
uöt64
 
x
;

104 
asm
 vﬁ©ûe("c§∏%0, mõ" : "Ù" (
x
) );

105  
x
;

106 
	}
}

108 
ölöe
 

109 
	$w_mõ
(
uöt64
 
x
)

111 
asm
 vﬁ©ûe("c§w mõ, %0" : : "r" (
x
));

112 
	}
}

117 
ölöe
 

118 
	$w_£pc
(
uöt64
 
x
)

120 
asm
 vﬁ©ûe("c§w sïc, %0" : : "r" (
x
));

121 
	}
}

123 
ölöe
 
uöt64


124 
	$r_£pc
()

126 
uöt64
 
x
;

127 
asm
 vﬁ©ûe("c§∏%0, sïc" : "Ù" (
x
) );

128  
x
;

129 
	}
}

132 
ölöe
 
uöt64


133 
	$r_medñeg
()

135 
uöt64
 
x
;

136 
asm
 vﬁ©ûe("c§∏%0, medñeg" : "Ù" (
x
) );

137  
x
;

138 
	}
}

140 
ölöe
 

141 
	$w_medñeg
(
uöt64
 
x
)

143 
asm
 vﬁ©ûe("c§w medñeg, %0" : : "r" (
x
));

144 
	}
}

147 
ölöe
 
uöt64


148 
	$r_midñeg
()

150 
uöt64
 
x
;

151 
asm
 vﬁ©ûe("c§∏%0, midñeg" : "Ù" (
x
) );

152  
x
;

153 
	}
}

155 
ölöe
 

156 
	$w_midñeg
(
uöt64
 
x
)

158 
asm
 vﬁ©ûe("c§w midñeg, %0" : : "r" (
x
));

159 
	}
}

163 
ölöe
 

164 
	$w_°vec
(
uöt64
 
x
)

166 
asm
 vﬁ©ûe("c§w stvec, %0" : : "r" (
x
));

167 
	}
}

169 
ölöe
 
uöt64


170 
	$r_°vec
()

172 
uöt64
 
x
;

173 
asm
 vﬁ©ûe("c§∏%0, stvec" : "Ù" (
x
) );

174  
x
;

175 
	}
}

178 
ölöe
 

179 
	$w_mtvec
(
uöt64
 
x
)

181 
asm
 vﬁ©ûe("c§w mtvec, %0" : : "r" (
x
));

182 
	}
}

185 
	#SATP_SV39
 (8L << 60)

	)

187 
	#MAKE_SATP
(
∑gëabÀ
Ë(
SATP_SV39
 | (((
uöt64
ÌagëabÀË>> 12))

	)

191 
ölöe
 

192 
	$w_ßç
(
uöt64
 
x
)

194 
asm
 vﬁ©ûe("c§w s©p, %0" : : "r" (
x
));

195 
	}
}

197 
ölöe
 
uöt64


198 
	$r_ßç
()

200 
uöt64
 
x
;

201 
asm
 vﬁ©ûe("c§∏%0, s©p" : "Ù" (
x
) );

202  
x
;

203 
	}
}

206 
ölöe
 

207 
	$w_ss¸©ch
(
uöt64
 
x
)

209 
asm
 vﬁ©ûe("c§w ss¸©ch, %0" : : "r" (
x
));

210 
	}
}

212 
ölöe
 

213 
	$w_ms¸©ch
(
uöt64
 
x
)

215 
asm
 vﬁ©ûe("c§w ms¸©ch, %0" : : "r" (
x
));

216 
	}
}

219 
ölöe
 
uöt64


220 
	$r_sˇu£
()

222 
uöt64
 
x
;

223 
asm
 vﬁ©ûe("c§∏%0, sˇu£" : "Ù" (
x
) );

224  
x
;

225 
	}
}

228 
ölöe
 
uöt64


229 
	$r_°vÆ
()

231 
uöt64
 
x
;

232 
asm
 vﬁ©ûe("c§∏%0, stvÆ" : "Ù" (
x
) );

233  
x
;

234 
	}
}

237 
ölöe
 

238 
	$w_mcou¡îí
(
uöt64
 
x
)

240 
asm
 vﬁ©ûe("c§w mcou¡îí, %0" : : "r" (
x
));

241 
	}
}

243 
ölöe
 
uöt64


244 
	$r_mcou¡îí
()

246 
uöt64
 
x
;

247 
asm
 vﬁ©ûe("c§∏%0, mcou¡îí" : "Ù" (
x
) );

248  
x
;

249 
	}
}

252 
ölöe
 
uöt64


253 
	$r_time
()

255 
uöt64
 
x
;

256 
asm
 vﬁ©ûe("c§∏%0,Åime" : "Ù" (
x
) );

257  
x
;

258 
	}
}

261 
ölöe
 

262 
	$öå_⁄
()

264 
	`w_s°©us
(
	`r_s°©us
(Ë| 
SSTATUS_SIE
);

265 
	}
}

268 
ölöe
 

269 
	$öå_off
()

271 
	`w_s°©us
(
	`r_s°©us
(Ë& ~
SSTATUS_SIE
);

272 
	}
}

275 
ölöe
 

276 
	$öå_gë
()

278 
uöt64
 
x
 = 
	`r_s°©us
();

279  (
x
 & 
SSTATUS_SIE
) != 0;

280 
	}
}

282 
ölöe
 
uöt64


283 
	$r_•
()

285 
uöt64
 
x
;

286 
asm
 vﬁ©ûe("mv %0, sp" : "Ù" (
x
) );

287  
x
;

288 
	}
}

292 
ölöe
 
uöt64


293 
	$r_ç
()

295 
uöt64
 
x
;

296 
asm
 vﬁ©ûe("mv %0,Åp" : "Ù" (
x
) );

297  
x
;

298 
	}
}

300 
ölöe
 

301 
	$w_ç
(
uöt64
 
x
)

303 
asm
 vﬁ©ûe("mvÅp, %0" : : "r" (
x
));

304 
	}
}

306 
ölöe
 
uöt64


307 
	$r_ø
()

309 
uöt64
 
x
;

310 
asm
 vﬁ©ûe("mv %0,Ña" : "Ù" (
x
) );

311  
x
;

312 
	}
}

315 
ölöe
 

316 
	$s„n˚_vma
()

319 
asm
 volatile("sfence.vma zero, zero");

320 
	}
}

323 
	#PGSIZE
 4096

324 
	#PGSHIFT
 12

325 

	)

326 
	#PGROUNDUP
(
sz
Ë(((sz)+
PGSIZE
-1Ë& ~(PGSIZE-1))

	)

327 
	#PGROUNDDOWN
(
a
Ë((◊)Ë& ~(
PGSIZE
-1))

	)

329 
	#PTE_V
 (1L << 0)

330 
	#PTE_R
 (1L << 1)

	)

331 
	#PTE_W
 (1L << 2)

	)

332 
	#PTE_X
 (1L << 3)

	)

333 
	#PTE_U
 (1L << 4)

334 

	)

336 
	#PA2PTE
(
∑
Ë((((
uöt64
ÌaË>> 12Ë<< 10)

	)

338 
	#PTE2PA
(
±e
Ë((’ãË>> 10Ë<< 12)

	)

340 
	#PTE_FLAGS
(
±e
Ë(’ãË& 0x3FF)

	)

343 
	#PXMASK
 0x1FF

344 
	#PXSHIFT
(
Àvñ
Ë(
PGSHIFT
+(9*÷evñ)))

	)

345 
	#PX
(
Àvñ
, 
va
Ë((((
uöt64
Ë(va)Ë>> 
	`PXSHIFT
÷evñ)Ë& 
PXMASK
)

	)

351 
	#MAXVA
 (1L << (9 + 9 + 9 + 12 - 1))

	)

353 
uöt64
 
	t±e_t
;

354 
uöt64
 *
	t∑gëabÀ_t
;

	@sleeplock.c

3 
	~"ty≥s.h
"

4 
	~"riscv.h
"

5 
	~"defs.h
"

6 
	~"∑øm.h
"

7 
	~"memœyout.h
"

8 
	~"•ölock.h
"

9 
	~"¥oc.h
"

10 
	~"¶ì∂ock.h
"

13 
	$öô¶ì∂ock
(
¶ì∂ock
 *
lk
, *
«me
)

15 
	`öôlock
(&
lk
->lk, "sleepÜock");

16 
lk
->
«me
 =Çame;

17 
lk
->
locked
 = 0;

18 
lk
->
pid
 = 0;

19 
	}
}

22 
	$acquúe¶ìp
(
¶ì∂ock
 *
lk
)

24 
	`acquúe
(&
lk
->lk);

25 
lk
->
locked
) {

26 
	`¶ìp
(
lk
, &lk->lk);

28 
lk
->
locked
 = 1;

29 
lk
->
pid
 = 
	`my¥oc
()->pid;

30 
	`ªÀa£
(&
lk
->lk);

31 
	}
}

34 
	$ªÀa£¶ìp
(
¶ì∂ock
 *
lk
)

36 
	`acquúe
(&
lk
->lk);

37 
lk
->
locked
 = 0;

38 
lk
->
pid
 = 0;

39 
	`wakeup
(
lk
);

40 
	`ªÀa£
(&
lk
->lk);

41 
	}
}

44 
	$hﬁdög¶ìp
(
¶ì∂ock
 *
lk
)

46 
r
;

48 
	`acquúe
(&
lk
->lk);

49 
r
 = 
lk
->
locked
 && (lk->
pid
 =
	`my¥oc
()->pid);

50 
	`ªÀa£
(&
lk
->lk);

51  
r
;

52 
	}
}

	@sleeplock.h

2 
	s¶ì∂ock
 {

3 
uöt
 
	mlocked
;

4 
•ölock
 
	mlk
;

7 *
	m«me
;

8 
	mpid
;

	@spinlock.c

3 
	~"ty≥s.h
"

4 
	~"∑øm.h
"

5 
	~"memœyout.h
"

6 
	~"•ölock.h
"

7 
	~"riscv.h
"

8 
	~"¥oc.h
"

9 
	~"defs.h
"

12 
	$öôlock
(
•ölock
 *
lk
, *
«me
)

14 
lk
->
«me
 =Çame;

15 
lk
->
locked
 = 0;

16 
lk
->
˝u
 = 0;

17 
	}
}

22 
	$acquúe
(
•ölock
 *
lk
)

24 
	`push_off
();

25 if(
	`hﬁdög
(
lk
))

26 
	`∑nic
("acquire");

32 
	`__sync_lock_ã°_™d_£t
(&
lk
->
locked
, 1) != 0)

39 
	`__sync_synchr⁄ize
();

42 
lk
->
˝u
 = 
	`my˝u
();

43 
	}
}

47 
	$ªÀa£
(
•ölock
 *
lk
)

49 if(!
	`hﬁdög
(
lk
))

50 
	`∑nic
("release");

52 
lk
->
˝u
 = 0;

60 
	`__sync_synchr⁄ize
();

69 
	`__sync_lock_ªÀa£
(&
lk
->
locked
);

71 
	`p›_off
();

72 
	}
}

77 
	$hﬁdög
(
•ölock
 *
lk
)

79 
r
;

80 
r
 = (
lk
->
locked
 &&Ük->
˝u
 =
	`my˝u
());

81  
r
;

82 
	}
}

89 
	$push_off
()

91 
ﬁd
 = 
	`öå_gë
();

93 
	`öå_off
();

94 if(
	`my˝u
()->
noff
 == 0)

95 
	`my˝u
()->
öã«
 = 
ﬁd
;

96 
	`my˝u
()->
noff
 += 1;

97 
	}
}

100 
	$p›_off
()

102 
˝u
 *
c
 = 
	`my˝u
();

103 if(
	`öå_gë
())

104 
	`∑nic
("pop_off - interruptible");

105 if(
c
->
noff
 < 1)

106 
	`∑nic
("pop_off");

107 
c
->
noff
 -= 1;

108 if(
c
->
noff
 =0 && c->
öã«
)

109 
	`öå_⁄
();

110 
	}
}

	@spinlock.h

2 
	s•ölock
 {

3 
uöt
 
	mlocked
;

6 *
	m«me
;

7 
˝u
 *
	m˝u
;

	@sprintf.c

1 
	~<°d¨g.h
>

3 
	~"ty≥s.h
"

4 
	~"∑øm.h
"

5 
	~"•ölock.h
"

6 
	~"¶ì∂ock.h
"

7 
	~"fs.h
"

8 
	~"fûe.h
"

9 
	~"riscv.h
"

10 
	~"defs.h
"

12 
	gdigôs
[] = "0123456789abcdef";

15 
	$•utc
(*
s
, 
c
)

17 *
s
 = 
c
;

19 
	}
}

22 
	$•rötöt
(*
s
, 
xx
, 
ba£
, 
sign
)

24 
buf
[16];

25 
i
, 
n
;

26 
uöt
 
x
;

28 if(
sign
 && (sig¿
xx
 < 0))

29 
x
 = -
xx
;

31 
x
 = 
xx
;

33 
i
 = 0;

35 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

36 } (
x
 /
ba£
) != 0);

38 if(
sign
)

39 
buf
[
i
++] = '-';

41 
n
 = 0;

42 --
i
 >= 0)

43 
n
 +
	`•utc
(
s
+n, 
buf
[
i
]);

44  
n
;

45 
	}
}

48 
	$¢¥ötf
(*
buf
, 
sz
, *
fmt
, ...)

50 
va_li°
 
≠
;

51 
i
, 
c
;

52 
off
 = 0;

53 *
s
;

55 i‡(
fmt
 == 0)

56 
	`∑nic
("null fmt");

58 
	`va_°¨t
(
≠
, 
fmt
);

59 
i
 = 0; 
off
 < 
sz
 && (
c
 = 
fmt
[i] & 0xff) != 0; i++){

60 if(
c
 != '%'){

61 
off
 +
	`•utc
(
buf
+off, 
c
);

64 
c
 = 
fmt
[++
i
] & 0xff;

65 if(
c
 == 0)

67 
c
){

69 
off
 +
	`•rötöt
(
buf
+off, 
	`va_¨g
(
≠
, ), 10, 1);

72 
off
 +
	`•rötöt
(
buf
+off, 
	`va_¨g
(
≠
, ), 16, 1);

75 if((
s
 = 
	`va_¨g
(
≠
, *)) == 0)

76 
s
 = "(null)";

77 ; *
s
 && 
off
 < 
sz
; s++)

78 
off
 +
	`•utc
(
buf
+off, *
s
);

81 
off
 +
	`•utc
(
buf
+off, '%');

85 
off
 +
	`•utc
(
buf
+off, '%');

86 
off
 +
	`•utc
(
buf
+off, 
c
);

90  
off
;

91 
	}
}

	@start.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"defs.h
"

7 
maö
();

8 
timîöô
();

11 
__©åibuã__
 ((
	$Æig√d
 (16))Ë
°ack0
[4096 * 
NCPU
];

14 
uöt64
 
ms¸©ch0
[
NCPU
 * 32];

17 
	`timîvec
();

21 
	$°¨t
()

24 
x
 = 
	`r_m°©us
();

25 
x
 &~
MSTATUS_MPP_MASK
;

26 
x
 |
MSTATUS_MPP_S
;

27 
	`w_m°©us
(
x
);

31 
	`w_mïc
((
uöt64
)
maö
);

34 
	`w_ßç
(0);

37 
	`w_medñeg
(0xffff);

38 
	`w_midñeg
(0xffff);

39 
	`w_sõ
(
	`r_sõ
(Ë| 
SIE_SEIE
 | 
SIE_STIE
 | 
SIE_SSIE
);

42 
	`timîöô
();

45 
id
 = 
	`r_mh¨tid
();

46 
	`w_ç
(
id
);

49 
asm
 volatile("mret");

50 
	}
}

57 
	$timîöô
()

60 
id
 = 
	`r_mh¨tid
();

63 
öãrvÆ
 = 1000000;

64 *(
uöt64
*)
	`CLINT_MTIMECMP
(
id
Ë*(uöt64*)
CLINT_MTIME
 + 
öãrvÆ
;

70 
uöt64
 *
s¸©ch
 = &
ms¸©ch0
[32 * 
id
];

71 
s¸©ch
[4] = 
	`CLINT_MTIMECMP
(
id
);

72 
s¸©ch
[5] = 
öãrvÆ
;

73 
	`w_ms¸©ch
((
uöt64
)
s¸©ch
);

76 
	`w_mtvec
((
uöt64
)
timîvec
);

79 
	`w_m°©us
(
	`r_m°©us
(Ë| 
MSTATUS_MIE
);

82 
	`w_mõ
(
	`r_mõ
(Ë| 
MIE_MTIE
);

83 
	}
}

	@stat.h

1 
	#T_DIR
 1

2 
	#T_FILE
 2

3 
	#T_DEVICE
 3

4 

	)

5 
	s°©
 {

6 
	mdev
;

7 
uöt
 
	möo
;

8 
	mty≥
;

9 
	m∆ök
;

10 
uöt64
 
	msize
;

	@stats.c

1 
	~<°d¨g.h
>

3 
	~"ty≥s.h
"

4 
	~"∑øm.h
"

5 
	~"•ölock.h
"

6 
	~"¶ì∂ock.h
"

7 
	~"fs.h
"

8 
	~"fûe.h
"

9 
	~"riscv.h
"

10 
	~"defs.h
"

12 
	#BUFSZ
 4096

	)

14 
•ölock
 
	mlock
;

15 
	mbuf
[
BUFSZ
];

16 
	msz
;

17 
	moff
;

18 } 
	g°©s
;

20 
°©sc›yö
(*, );

21 
°©¶ock
(*, );

24 
	$°©swrôe
(
u£r_§c
, 
uöt64
 
§c
, 
n
)

27 
	}
}

30 
	$°©§ód
(
u£r_d°
, 
uöt64
 
d°
, 
n
)

32 
m
;

34 
	`acquúe
(&
°©s
.
lock
);

36 if(
°©s
.
sz
 == 0) {

37 #ifde‡
LAB_PGTBL


38 
°©s
.
sz
 = 
	`°©sc›yö
(°©s.
buf
, 
BUFSZ
);

40 #ifde‡
LAB_LOCK


41 
°©s
.
sz
 = 
	`°©¶ock
(°©s.
buf
, 
BUFSZ
);

44 
m
 = 
°©s
.
sz
 - sèts.
off
;

46 i‡(
m
 > 0) {

47 if(
m
 > 
n
)

48 
m
 = 
n
;

49 if(
	`eôhî_c›yout
(
u£r_d°
, 
d°
, 
°©s
.
buf
+°©s.
off
, 
m
) != -1) {

50 
°©s
.
off
 +
m
;

53 
m
 = -1;

54 
°©s
.
sz
 = 0;

55 
°©s
.
off
 = 0;

57 
	`ªÀa£
(&
°©s
.
lock
);

58  
m
;

59 
	}
}

62 
	$°©söô
()

64 
	`öôlock
(&
°©s
.
lock
, "stats");

66 
devsw
[
STATS
].
ªad
 = 
°©§ód
;

67 
devsw
[
STATS
].
wrôe
 = 
°©swrôe
;

68 
	}
}

	@string.c

1 
	~"ty≥s.h
"

4 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

6 *
cd°
 = (*Ë
d°
;

7 
i
;

8 
i
 = 0; i < 
n
; i++){

9 
cd°
[
i
] = 
c
;

11  
d°
;

12 
	}
}

15 
	$memcmp
(c⁄° *
v1
, c⁄° *
v2
, 
uöt
 
n
)

17 c⁄° 
uch¨
 *
s1
, *
s2
;

19 
s1
 = 
v1
;

20 
s2
 = 
v2
;

21 
n
-- > 0){

22 if(*
s1
 !*
s2
)

23  *
s1
 - *
s2
;

24 
s1
++, 
s2
++;

28 
	}
}

31 
	$memmove
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

33 c⁄° *
s
;

34 *
d
;

36 
s
 = 
§c
;

37 
d
 = 
d°
;

38 if(
s
 < 
d
 && s + 
n
 > d){

39 
s
 +
n
;

40 
d
 +
n
;

41 
n
-- > 0)

42 *--
d
 = *--
s
;

44 
n
-- > 0)

45 *
d
++ = *
s
++;

47  
d°
;

48 
	}
}

52 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

54  
	`memmove
(
d°
, 
§c
, 
n
);

55 
	}
}

58 
	$°∫cmp
(c⁄° *
p
, c⁄° *
q
, 
uöt
 
n
)

60 
n
 > 0 && *
p
 && *∞=*
q
)

61 
n
--, 
p
++, 
q
++;

62 if(
n
 == 0)

64  (
uch¨
)*
p
 - (uch¨)*
q
;

65 
	}
}

68 
	$°∫˝y
(*
s
, c⁄° *
t
, 
n
)

70 *
os
;

72 
os
 = 
s
;

73 
n
-- > 0 && (*
s
++ = *
t
++) != 0)

75 
n
-- > 0)

76 *
s
++ = 0;

77  
os
;

78 
	}
}

82 
	$ß„°r˝y
(*
s
, c⁄° *
t
, 
n
)

84 *
os
;

86 
os
 = 
s
;

87 if(
n
 <= 0)

88  
os
;

89 --
n
 > 0 && (*
s
++ = *
t
++) != 0)

91 *
s
 = 0;

92  
os
;

93 
	}
}

96 
	$°æí
(c⁄° *
s
)

98 
n
;

100 
n
 = 0; 
s
[n];Ç++)

102  
n
;

103 
	}
}

	@syscall.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

7 
	~"sysˇŒ.h
"

8 
	~"defs.h
"

12 
	$„tchaddr
(
uöt64
 
addr
, uöt64 *
ù
)

14 
¥oc
 *
p
 = 
	`my¥oc
();

15 if(
addr
 >
p
->
sz
 ||áddr+(
uöt64
) >Ö->sz)

17 if(
	`c›yö
(
p
->
∑gëabÀ
, (*)
ù
, 
addr
, (*ip)) != 0)

20 
	}
}

25 
	$„tch°r
(
uöt64
 
addr
, *
buf
, 
max
)

27 
¥oc
 *
p
 = 
	`my¥oc
();

28 
îr
 = 
	`c›yö°r
(
p
->
∑gëabÀ
, 
buf
, 
addr
, 
max
);

29 if(
îr
 < 0)

30  
îr
;

31  
	`°æí
(
buf
);

32 
	}
}

34 
uöt64


35 
	$¨gøw
(
n
)

37 
¥oc
 *
p
 = 
	`my¥oc
();

38 
n
) {

40  
p
->
å≠‰ame
->
a0
;

42  
p
->
å≠‰ame
->
a1
;

44  
p
->
å≠‰ame
->
a2
;

46  
p
->
å≠‰ame
->
a3
;

48  
p
->
å≠‰ame
->
a4
;

50  
p
->
å≠‰ame
->
a5
;

52 
	`∑nic
("argraw");

54 
	}
}

58 
	$¨göt
(
n
, *
ù
)

60 *
ù
 = 
	`¨gøw
(
n
);

62 
	}
}

68 
	$¨gaddr
(
n
, 
uöt64
 *
ù
)

70 *
ù
 = 
	`¨gøw
(
n
);

72 
	}
}

78 
	$¨g°r
(
n
, *
buf
, 
max
)

80 
uöt64
 
addr
;

81 if(
	`¨gaddr
(
n
, &
addr
) < 0)

83  
	`„tch°r
(
addr
, 
buf
, 
max
);

84 
	}
}

86 
uöt64
 
sys_chdú
();

87 
uöt64
 
sys_˛o£
();

88 
uöt64
 
sys_dup
();

89 
uöt64
 
sys_exec
();

90 
uöt64
 
sys_exô
();

91 
uöt64
 
sys_f‹k
();

92 
uöt64
 
sys_f°©
();

93 
uöt64
 
sys_gëpid
();

94 
uöt64
 
sys_kûl
();

95 
uöt64
 
sys_lök
();

96 
uöt64
 
sys_mkdú
();

97 
uöt64
 
sys_mknod
();

98 
uöt64
 
sys_›í
();

99 
uöt64
 
sys_pùe
();

100 
uöt64
 
sys_ªad
();

101 
uöt64
 
sys_sbrk
();

102 
uöt64
 
sys_¶ìp
();

103 
uöt64
 
sys_u∆ök
();

104 
uöt64
 
sys_waô
();

105 
uöt64
 
sys_wrôe
();

106 
uöt64
 
sys_u±ime
();

108 
	$uöt64
 (*
sysˇŒs
[])() = {

109 [
SYS_f‹k
] 
sys_f‹k
,

110 [
SYS_exô
] 
sys_exô
,

111 [
SYS_waô
] 
sys_waô
,

112 [
SYS_pùe
] 
sys_pùe
,

113 [
SYS_ªad
] 
sys_ªad
,

114 [
SYS_kûl
] 
sys_kûl
,

115 [
SYS_exec
] 
sys_exec
,

116 [
SYS_f°©
] 
sys_f°©
,

117 [
SYS_chdú
] 
sys_chdú
,

118 [
SYS_dup
] 
sys_dup
,

119 [
SYS_gëpid
] 
sys_gëpid
,

120 [
SYS_sbrk
] 
sys_sbrk
,

121 [
SYS_¶ìp
] 
sys_¶ìp
,

122 [
SYS_u±ime
] 
sys_u±ime
,

123 [
SYS_›í
] 
sys_›í
,

124 [
SYS_wrôe
] 
sys_wrôe
,

125 [
SYS_mknod
] 
sys_mknod
,

126 [
SYS_u∆ök
] 
sys_u∆ök
,

127 [
SYS_lök
] 
sys_lök
,

128 [
SYS_mkdú
] 
sys_mkdú
,

129 [
SYS_˛o£
] 
sys_˛o£
,

130 
	}
};

133 
	$sysˇŒ
()

135 
num
;

136 
¥oc
 *
p
 = 
	`my¥oc
();

138 
num
 = 
p
->
å≠‰ame
->
a7
;

139 if(
num
 > 0 &&Çum < 
	`NELEM
(
sysˇŒs
) && syscalls[num]) {

140 
p
->
å≠‰ame
->
a0
 = 
sysˇŒs
[
num
]();

142 
	`¥ötf
("%d %s: unknown sys call %d\n",

143 
p
->
pid
,Ö->
«me
, 
num
);

144 
p
->
å≠‰ame
->
a0
 = -1;

146 
	}
}

	@syscall.h

2 
	#SYS_f‹k
 1

	)

3 
	#SYS_exô
 2

	)

4 
	#SYS_waô
 3

	)

5 
	#SYS_pùe
 4

	)

6 
	#SYS_ªad
 5

	)

7 
	#SYS_kûl
 6

	)

8 
	#SYS_exec
 7

	)

9 
	#SYS_f°©
 8

	)

10 
	#SYS_chdú
 9

	)

11 
	#SYS_dup
 10

	)

12 
	#SYS_gëpid
 11

	)

13 
	#SYS_sbrk
 12

	)

14 
	#SYS_¶ìp
 13

	)

15 
	#SYS_u±ime
 14

	)

16 
	#SYS_›í
 15

	)

17 
	#SYS_wrôe
 16

	)

18 
	#SYS_mknod
 17

	)

19 
	#SYS_u∆ök
 18

	)

20 
	#SYS_lök
 19

	)

21 
	#SYS_mkdú
 20

	)

22 
	#SYS_˛o£
 21

	)

	@sysfile.c

7 
	~"ty≥s.h
"

8 
	~"riscv.h
"

9 
	~"defs.h
"

10 
	~"∑øm.h
"

11 
	~"°©.h
"

12 
	~"•ölock.h
"

13 
	~"¥oc.h
"

14 
	~"fs.h
"

15 
	~"¶ì∂ock.h
"

16 
	~"fûe.h
"

17 
	~"f˙é.h
"

22 
	$¨gfd
(
n
, *
pfd
, 
fûe
 **
pf
)

24 
fd
;

25 
fûe
 *
f
;

27 if(
	`¨göt
(
n
, &
fd
) < 0)

29 if(
fd
 < 0 || fd >
NOFILE
 || (
f
=
	`my¥oc
()->
ofûe
[fd]) == 0)

31 if(
pfd
)

32 *
pfd
 = 
fd
;

33 if(
pf
)

34 *
pf
 = 
f
;

36 
	}
}

41 
	$fdÆloc
(
fûe
 *
f
)

43 
fd
;

44 
¥oc
 *
p
 = 
	`my¥oc
();

46 
fd
 = 0; fd < 
NOFILE
; fd++){

47 if(
p
->
ofûe
[
fd
] == 0){

48 
p
->
ofûe
[
fd
] = 
f
;

49  
fd
;

53 
	}
}

55 
uöt64


56 
	$sys_dup
()

58 
fûe
 *
f
;

59 
fd
;

61 if(
	`¨gfd
(0, 0, &
f
) < 0)

63 if((
fd
=
	`fdÆloc
(
f
)) < 0)

65 
	`fûedup
(
f
);

66  
fd
;

67 
	}
}

69 
uöt64


70 
	$sys_ªad
()

72 
fûe
 *
f
;

73 
n
;

74 
uöt64
 
p
;

76 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨gaddr
(1, &
p
) < 0)

78  
	`fûîód
(
f
, 
p
, 
n
);

79 
	}
}

81 
uöt64


82 
	$sys_wrôe
()

84 
fûe
 *
f
;

85 
n
;

86 
uöt64
 
p
;

88 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨göt
(2, &
n
Ë< 0 || 
	`¨gaddr
(1, &
p
) < 0)

91  
	`fûewrôe
(
f
, 
p
, 
n
);

92 
	}
}

94 
uöt64


95 
	$sys_˛o£
()

97 
fd
;

98 
fûe
 *
f
;

100 if(
	`¨gfd
(0, &
fd
, &
f
) < 0)

102 
	`my¥oc
()->
ofûe
[
fd
] = 0;

103 
	`fûe˛o£
(
f
);

105 
	}
}

107 
uöt64


108 
	$sys_f°©
()

110 
fûe
 *
f
;

111 
uöt64
 
°
;

113 if(
	`¨gfd
(0, 0, &
f
Ë< 0 || 
	`¨gaddr
(1, &
°
) < 0)

115  
	`fûe°©
(
f
, 
°
);

116 
	}
}

119 
uöt64


120 
	$sys_lök
()

122 
«me
[
DIRSIZ
], 
√w
[
MAXPATH
], 
ﬁd
[MAXPATH];

123 
öode
 *
dp
, *
ù
;

125 if(
	`¨g°r
(0, 
ﬁd
, 
MAXPATH
Ë< 0 ||árg°r(1, 
√w
, MAXPATH) < 0)

128 
	`begö_›
();

129 if((
ù
 = 
	`«mei
(
ﬁd
)) == 0){

130 
	`íd_›
();

134 
	`ûock
(
ù
);

135 if(
ù
->
ty≥
 =
T_DIR
){

136 
	`iu∆ockput
(
ù
);

137 
	`íd_›
();

141 
ù
->
∆ök
++;

142 
	`iupd©e
(
ù
);

143 
	`iu∆ock
(
ù
);

145 if((
dp
 = 
	`«meù¨ít
(
√w
, 
«me
)) == 0)

146 
bad
;

147 
	`ûock
(
dp
);

148 if(
dp
->
dev
 !
ù
->dev || 
	`dúlök
(dp, 
«me
, ip->
öum
) < 0){

149 
	`iu∆ockput
(
dp
);

150 
bad
;

152 
	`iu∆ockput
(
dp
);

153 
	`ùut
(
ù
);

155 
	`íd_›
();

159 
bad
:

160 
	`ûock
(
ù
);

161 
ù
->
∆ök
--;

162 
	`iupd©e
(
ù
);

163 
	`iu∆ockput
(
ù
);

164 
	`íd_›
();

166 
	}
}

170 
	$isdúem±y
(
öode
 *
dp
)

172 
off
;

173 
dúít
 
de
;

175 
off
=2*(
de
); off<
dp
->
size
; off+=(de)){

176 if(
	`ªadi
(
dp
, 0, (
uöt64
)&
de
, 
off
, (de)) != (de))

177 
	`∑nic
("isdirempty:Ñeadi");

178 if(
de
.
öum
 != 0)

182 
	}
}

184 
uöt64


185 
	$sys_u∆ök
()

187 
öode
 *
ù
, *
dp
;

188 
dúít
 
de
;

189 
«me
[
DIRSIZ
], 
∑th
[
MAXPATH
];

190 
uöt
 
off
;

192 if(
	`¨g°r
(0, 
∑th
, 
MAXPATH
) < 0)

195 
	`begö_›
();

196 if((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0){

197 
	`íd_›
();

201 
	`ûock
(
dp
);

204 if(
	`«mecmp
(
«me
, ".") == 0 ||Çamecmp(name, "..") == 0)

205 
bad
;

207 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, &
off
)) == 0)

208 
bad
;

209 
	`ûock
(
ù
);

211 if(
ù
->
∆ök
 < 1)

212 
	`∑nic
("unlink:Çlink < 1");

213 if(
ù
->
ty≥
 =
T_DIR
 && !
	`isdúem±y
(ip)){

214 
	`iu∆ockput
(
ù
);

215 
bad
;

218 
	`mem£t
(&
de
, 0, (de));

219 if(
	`wrôei
(
dp
, 0, (
uöt64
)&
de
, 
off
, (de)) != (de))

220 
	`∑nic
("unlink: writei");

221 if(
ù
->
ty≥
 =
T_DIR
){

222 
dp
->
∆ök
--;

223 
	`iupd©e
(
dp
);

225 
	`iu∆ockput
(
dp
);

227 
ù
->
∆ök
--;

228 
	`iupd©e
(
ù
);

229 
	`iu∆ockput
(
ù
);

231 
	`íd_›
();

235 
bad
:

236 
	`iu∆ockput
(
dp
);

237 
	`íd_›
();

239 
	}
}

241 
öode
*

242 
	$¸óã
(*
∑th
, 
ty≥
, 
maj‹
, 
mö‹
)

244 
öode
 *
ù
, *
dp
;

245 
«me
[
DIRSIZ
];

247 if((
dp
 = 
	`«meù¨ít
(
∑th
, 
«me
)) == 0)

250 
	`ûock
(
dp
);

252 if((
ù
 = 
	`dúlookup
(
dp
, 
«me
, 0)) != 0){

253 
	`iu∆ockput
(
dp
);

254 
	`ûock
(
ù
);

255 if(
ty≥
 =
T_FILE
 && (
ù
->ty≥ =T_FILE || ip->ty≥ =
T_DEVICE
))

256  
ù
;

257 
	`iu∆ockput
(
ù
);

261 if((
ù
 = 
	`üŒoc
(
dp
->
dev
, 
ty≥
)) == 0)

262 
	`∑nic
("create: ialloc");

264 
	`ûock
(
ù
);

265 
ù
->
maj‹
 = major;

266 
ù
->
mö‹
 = minor;

267 
ù
->
∆ök
 = 1;

268 
	`iupd©e
(
ù
);

270 if(
ty≥
 =
T_DIR
){

271 
dp
->
∆ök
++;

272 
	`iupd©e
(
dp
);

274 if(
	`dúlök
(
ù
, ".", ip->
öum
Ë< 0 || dúlök(ù, "..", 
dp
->inum) < 0)

275 
	`∑nic
("create dots");

278 if(
	`dúlök
(
dp
, 
«me
, 
ù
->
öum
) < 0)

279 
	`∑nic
("create: dirlink");

281 
	`iu∆ockput
(
dp
);

283  
ù
;

284 
	}
}

286 
uöt64


287 
	$sys_›í
()

289 
∑th
[
MAXPATH
];

290 
fd
, 
omode
;

291 
fûe
 *
f
;

292 
öode
 *
ù
;

293 
n
;

295 if((
n
 = 
	`¨g°r
(0, 
∑th
, 
MAXPATH
)Ë< 0 || 
	`¨göt
(1, &
omode
) < 0)

298 
	`begö_›
();

300 if(
omode
 & 
O_CREATE
){

301 
ù
 = 
	`¸óã
(
∑th
, 
T_FILE
, 0, 0);

302 if(
ù
 == 0){

303 
	`íd_›
();

307 if((
ù
 = 
	`«mei
(
∑th
)) == 0){

308 
	`íd_›
();

311 
	`ûock
(
ù
);

312 if(
ù
->
ty≥
 =
T_DIR
 && 
omode
 !
O_RDONLY
){

313 
	`iu∆ockput
(
ù
);

314 
	`íd_›
();

319 if(
ù
->
ty≥
 =
T_DEVICE
 && (ù->
maj‹
 < 0 || ip->maj‹ >
NDEV
)){

320 
	`iu∆ockput
(
ù
);

321 
	`íd_›
();

325 if((
f
 = 
	`fûóŒoc
()Ë=0 || (
fd
 = 
	`fdÆloc
(f)) < 0){

326 if(
f
)

327 
	`fûe˛o£
(
f
);

328 
	`iu∆ockput
(
ù
);

329 
	`íd_›
();

333 if(
ù
->
ty≥
 =
T_DEVICE
){

334 
f
->
ty≥
 = 
FD_DEVICE
;

335 
f
->
maj‹
 = 
ù
->major;

337 
f
->
ty≥
 = 
FD_INODE
;

338 
f
->
off
 = 0;

340 
f
->
ù
 = ip;

341 
f
->
ªadabÀ
 = !(
omode
 & 
O_WRONLY
);

342 
f
->
wrôabÀ
 = (
omode
 & 
O_WRONLY
Ë|| (omodê& 
O_RDWR
);

344 if((
omode
 & 
O_TRUNC
Ë&& 
ù
->
ty≥
 =
T_FILE
){

345 
	`ôrunc
(
ù
);

348 
	`iu∆ock
(
ù
);

349 
	`íd_›
();

351  
fd
;

352 
	}
}

354 
uöt64


355 
	$sys_mkdú
()

357 
∑th
[
MAXPATH
];

358 
öode
 *
ù
;

360 
	`begö_›
();

361 if(
	`¨g°r
(0, 
∑th
, 
MAXPATH
Ë< 0 || (
ù
 = 
	`¸óã
’©h, 
T_DIR
, 0, 0)) == 0){

362 
	`íd_›
();

365 
	`iu∆ockput
(
ù
);

366 
	`íd_›
();

368 
	}
}

370 
uöt64


371 
	$sys_mknod
()

373 
öode
 *
ù
;

374 
∑th
[
MAXPATH
];

375 
maj‹
, 
mö‹
;

377 
	`begö_›
();

378 if((
	`¨g°r
(0, 
∑th
, 
MAXPATH
)) < 0 ||

379 
	`¨göt
(1, &
maj‹
) < 0 ||

380 
	`¨göt
(2, &
mö‹
) < 0 ||

381 (
ù
 = 
	`¸óã
(
∑th
, 
T_DEVICE
, 
maj‹
, 
mö‹
)) == 0){

382 
	`íd_›
();

385 
	`iu∆ockput
(
ù
);

386 
	`íd_›
();

388 
	}
}

390 
uöt64


391 
	$sys_chdú
()

393 
∑th
[
MAXPATH
];

394 
öode
 *
ù
;

395 
¥oc
 *
p
 = 
	`my¥oc
();

397 
	`begö_›
();

398 if(
	`¨g°r
(0, 
∑th
, 
MAXPATH
Ë< 0 || (
ù
 = 
	`«mei
(path)) == 0){

399 
	`íd_›
();

402 
	`ûock
(
ù
);

403 if(
ù
->
ty≥
 !
T_DIR
){

404 
	`iu∆ockput
(
ù
);

405 
	`íd_›
();

408 
	`iu∆ock
(
ù
);

409 
	`ùut
(
p
->
cwd
);

410 
	`íd_›
();

411 
p
->
cwd
 = 
ù
;

413 
	}
}

415 
uöt64


416 
	$sys_exec
()

418 
∑th
[
MAXPATH
], *
¨gv
[
MAXARG
];

419 
i
;

420 
uöt64
 
u¨gv
, 
u¨g
;

422 if(
	`¨g°r
(0, 
∑th
, 
MAXPATH
Ë< 0 || 
	`¨gaddr
(1, &
u¨gv
) < 0){

425 
	`mem£t
(
¨gv
, 0, (argv));

426 
i
=0;; i++){

427 if(
i
 >
	`NELEM
(
¨gv
)){

428 
bad
;

430 if(
	`„tchaddr
(
u¨gv
+(
uöt64
)*
i
, (uöt64*)&
u¨g
) < 0){

431 
bad
;

433 if(
u¨g
 == 0){

434 
¨gv
[
i
] = 0;

437 
¨gv
[
i
] = 
	`kÆloc
();

438 if(
¨gv
[
i
] == 0)

439 
bad
;

440 if(
	`„tch°r
(
u¨g
, 
¨gv
[
i
], 
PGSIZE
) < 0)

441 
bad
;

444 
ªt
 = 
	`exec
(
∑th
, 
¨gv
);

446 
i
 = 0; i < 
	`NELEM
(
¨gv
) &&árgv[i] != 0; i++)

447 
	`k‰ì
(
¨gv
[
i
]);

449  
ªt
;

451 
bad
:

452 
i
 = 0; i < 
	`NELEM
(
¨gv
) &&árgv[i] != 0; i++)

453 
	`k‰ì
(
¨gv
[
i
]);

455 
	}
}

457 
uöt64


458 
	$sys_pùe
()

460 
uöt64
 
fd¨øy
;

461 
fûe
 *
rf
, *
wf
;

462 
fd0
, 
fd1
;

463 
¥oc
 *
p
 = 
	`my¥oc
();

465 if(
	`¨gaddr
(0, &
fd¨øy
) < 0)

467 if(
	`pùóŒoc
(&
rf
, &
wf
) < 0)

469 
fd0
 = -1;

470 if((
fd0
 = 
	`fdÆloc
(
rf
)Ë< 0 || (
fd1
 = fdÆloc(
wf
)) < 0){

471 if(
fd0
 >= 0)

472 
p
->
ofûe
[
fd0
] = 0;

473 
	`fûe˛o£
(
rf
);

474 
	`fûe˛o£
(
wf
);

477 if(
	`c›yout
(
p
->
∑gëabÀ
, 
fd¨øy
, (*)&
fd0
, (fd0)) < 0 ||

478 
	`c›yout
(
p
->
∑gëabÀ
, 
fd¨øy
+(
fd0
), (*)&
fd1
, (fd1)) < 0){

479 
p
->
ofûe
[
fd0
] = 0;

480 
p
->
ofûe
[
fd1
] = 0;

481 
	`fûe˛o£
(
rf
);

482 
	`fûe˛o£
(
wf
);

486 
	}
}

	@sysproc.c

1 
	~"ty≥s.h
"

2 
	~"riscv.h
"

3 
	~"defs.h
"

4 
	~"d©e.h
"

5 
	~"∑øm.h
"

6 
	~"memœyout.h
"

7 
	~"•ölock.h
"

8 
	~"¥oc.h
"

10 
uöt64


11 
	$sys_exô
()

13 
n
;

14 if(
	`¨göt
(0, &
n
) < 0)

16 
	`exô
(
n
);

18 
	}
}

20 
uöt64


21 
	$sys_gëpid
()

23  
	`my¥oc
()->
pid
;

24 
	}
}

26 
uöt64


27 
	$sys_f‹k
()

29  
	`f‹k
();

30 
	}
}

32 
uöt64


33 
	$sys_waô
()

35 
uöt64
 
p
;

36 if(
	`¨gaddr
(0, &
p
) < 0)

38  
	`waô
(
p
);

39 
	}
}

41 
uöt64


42 
	$sys_sbrk
()

44 
addr
;

45 
n
;

47 if(
	`¨göt
(0, &
n
) < 0)

49 
addr
 = 
	`my¥oc
()->
sz
;

50 if(
	`grow¥oc
(
n
) < 0)

52  
addr
;

53 
	}
}

55 
uöt64


56 
	$sys_¶ìp
()

58 
n
;

59 
uöt
 
ticks0
;

61 if(
	`¨göt
(0, &
n
) < 0)

63 
	`acquúe
(&
tick¶ock
);

64 
ticks0
 = 
ticks
;

65 
ticks
 - 
ticks0
 < 
n
){

66 if(
	`my¥oc
()->
kûÀd
){

67 
	`ªÀa£
(&
tick¶ock
);

70 
	`¶ìp
(&
ticks
, &
tick¶ock
);

72 
	`ªÀa£
(&
tick¶ock
);

74 
	}
}

76 
uöt64


77 
	$sys_kûl
()

79 
pid
;

81 if(
	`¨göt
(0, &
pid
) < 0)

83  
	`kûl
(
pid
);

84 
	}
}

88 
uöt64


89 
	$sys_u±ime
()

91 
uöt
 
xticks
;

93 
	`acquúe
(&
tick¶ock
);

94 
xticks
 = 
ticks
;

95 
	`ªÀa£
(&
tick¶ock
);

96  
xticks
;

97 
	}
}

	@trap.c

1 
	~"ty≥s.h
"

2 
	~"∑øm.h
"

3 
	~"memœyout.h
"

4 
	~"riscv.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

7 
	~"defs.h
"

9 
•ölock
 
	gtick¶ock
;

10 
uöt
 
	gticks
;

12 
åampﬁöe
[], 
u£rvec
[], 
u£ºë
[];

15 
kî√lvec
();

17 
devöå
();

20 
	$å≠öô
()

22 
	`öôlock
(&
tick¶ock
, "time");

23 
	}
}

27 
	$å≠öôh¨t
()

29 
	`w_°vec
((
uöt64
)
kî√lvec
);

30 
	}
}

37 
	$u£πøp
()

39 
which_dev
 = 0;

41 if((
	`r_s°©us
(Ë& 
SSTATUS_SPP
) != 0)

42 
	`∑nic
("usertrap:Çot from user mode");

46 
	`w_°vec
((
uöt64
)
kî√lvec
);

48 
¥oc
 *
p
 = 
	`my¥oc
();

51 
p
->
å≠‰ame
->
ïc
 = 
	`r_£pc
();

53 if(
	`r_sˇu£
() == 8){

56 if(
p
->
kûÀd
)

57 
	`exô
(-1);

61 
p
->
å≠‰ame
->
ïc
 += 4;

65 
	`öå_⁄
();

67 
	`sysˇŒ
();

68 } if((
which_dev
 = 
	`devöå
()) != 0){

71 
	`¥ötf
("u£πøp(): u√x≥˘ed sˇu£ %∞pid=%d\n", 
	`r_sˇu£
(), 
p
->
pid
);

72 
	`¥ötf
(" sïc=%∞°vÆ=%p\n", 
	`r_£pc
(), 
	`r_°vÆ
());

73 
p
->
kûÀd
 = 1;

76 if(
p
->
kûÀd
)

77 
	`exô
(-1);

80 if(
which_dev
 == 2)

81 
	`yõld
();

83 
	`u£πø¥ë
();

84 
	}
}

90 
	$u£πø¥ë
()

92 
¥oc
 *
p
 = 
	`my¥oc
();

97 
	`öå_off
();

100 
	`w_°vec
(
TRAMPOLINE
 + (
u£rvec
 - 
åampﬁöe
));

104 
p
->
å≠‰ame
->
kî√l_ßç
 = 
	`r_ßç
();

105 
p
->
å≠‰ame
->
kî√l_•
 =Ö->
k°ack
 + 
PGSIZE
;

106 
p
->
å≠‰ame
->
kî√l_å≠
 = (
uöt64
)
u£πøp
;

107 
p
->
å≠‰ame
->
kî√l_h¨tid
 = 
	`r_ç
();

113 
x
 = 
	`r_s°©us
();

114 
x
 &~
SSTATUS_SPP
;

115 
x
 |
SSTATUS_SPIE
;

116 
	`w_s°©us
(
x
);

119 
	`w_£pc
(
p
->
å≠‰ame
->
ïc
);

122 
uöt64
 
ßç
 = 
	`MAKE_SATP
(
p
->
∑gëabÀ
);

127 
uöt64
 
‚
 = 
TRAMPOLINE
 + (
u£ºë
 - 
åampﬁöe
);

128 (((*)(
uöt64
,uöt64))
‚
)(
TRAPFRAME
, 
ßç
);

129 
	}
}

134 
	$kî√…øp
()

136 
which_dev
 = 0;

137 
uöt64
 
£pc
 = 
	`r_£pc
();

138 
uöt64
 
s°©us
 = 
	`r_s°©us
();

139 
uöt64
 
sˇu£
 = 
	`r_sˇu£
();

141 if((
s°©us
 & 
SSTATUS_SPP
) == 0)

142 
	`∑nic
("kerneltrap:Çot from supervisor mode");

143 if(
	`öå_gë
() != 0)

144 
	`∑nic
("kerneltrap: interruptsÉnabled");

146 if((
which_dev
 = 
	`devöå
()) == 0){

147 
	`¥ötf
("sˇu£ %p\n", 
sˇu£
);

148 
	`¥ötf
("£pc=%∞°vÆ=%p\n", 
	`r_£pc
(), 
	`r_°vÆ
());

149 
	`∑nic
("kerneltrap");

153 if(
which_dev
 =2 && 
	`my¥oc
(Ë!0 && my¥oc()->
°©e
 =
RUNNING
)

154 
	`yõld
();

158 
	`w_£pc
(
£pc
);

159 
	`w_s°©us
(
s°©us
);

160 
	}
}

163 
	$˛ocköå
()

165 
	`acquúe
(&
tick¶ock
);

166 
ticks
++;

167 
	`wakeup
(&
ticks
);

168 
	`ªÀa£
(&
tick¶ock
);

169 
	}
}

177 
	$devöå
()

179 
uöt64
 
sˇu£
 = 
	`r_sˇu£
();

181 if((
sˇu£
 & 0x8000000000000000L) &&

182 (
sˇu£
 & 0xff) == 9){

186 
úq
 = 
	`∂ic_˛aim
();

188 if(
úq
 =
UART0_IRQ
){

189 
	`u¨töå
();

190 } if(
úq
 =
VIRTIO0_IRQ
){

191 
	`vútio_disk_öå
();

192 } if(
úq
){

193 
	`¥ötf
("u√x≥˘ed i¡îru± irq=%d\n", 
úq
);

199 if(
úq
)

200 
	`∂ic_com∂ëe
(
úq
);

203 } if(
sˇu£
 == 0x8000000000000001L){

207 if(
	`˝uid
() == 0){

208 
	`˛ocköå
();

213 
	`w_sù
(
	`r_sù
() & ~2);

219 
	}
}

	@types.h

1 
	tuöt
;

2 
	tush‹t
;

3 
	tuch¨
;

5 
	tuöt8
;

6 
	tuöt16
;

7 
	tuöt32
;

8 
	tuöt64
;

10 
uöt64
 
	tpde_t
;

	@uart.c

5 
	~"ty≥s.h
"

6 
	~"∑øm.h
"

7 
	~"memœyout.h
"

8 
	~"riscv.h
"

9 
	~"•ölock.h
"

10 
	~"¥oc.h
"

11 
	~"defs.h
"

16 
	#Reg
(
ªg
Ë((vﬁ©ûê*)(
UART0
 +Ñeg))

	)

22 
	#RHR
 0

23 
	#THR
 0

24 
	#IER
 1

25 
	#IER_TX_ENABLE
 (1<<0)

	)

26 
	#IER_RX_ENABLE
 (1<<1)

	)

27 
	#FCR
 2

28 
	#FCR_FIFO_ENABLE
 (1<<0)

	)

29 
	#FCR_FIFO_CLEAR
 (3<<1)

30 
	#ISR
 2

31 
	#LCR
 3

32 
	#LCR_EIGHT_BITS
 (3<<0)

	)

33 
	#LCR_BAUD_LATCH
 (1<<7)

34 
	#LSR
 5

35 
	#LSR_RX_READY
 (1<<0)

36 
	#LSR_TX_IDLE
 (1<<5)

37 

	)

38 
	#RódReg
(
ªg
Ë(*(
	`Reg
‘eg)))

	)

39 
	#WrôeReg
(
ªg
, 
v
Ë(*(
	`Reg
‘eg)Ë(v))

	)

42 
•ölock
 
	gu¨t_tx_lock
;

43 
	#UART_TX_BUF_SIZE
 32

	)

44 
	gu¨t_tx_buf
[
UART_TX_BUF_SIZE
];

45 
	gu¨t_tx_w
;

46 
	gu¨t_tx_r
;

48 vﬁ©ûê
∑nicked
;

50 
u¨t°¨t
();

53 
	$u¨töô
()

56 
	`WrôeReg
(
IER
, 0x00);

59 
	`WrôeReg
(
LCR
, 
LCR_BAUD_LATCH
);

62 
	`WrôeReg
(0, 0x03);

65 
	`WrôeReg
(1, 0x00);

69 
	`WrôeReg
(
LCR
, 
LCR_EIGHT_BITS
);

72 
	`WrôeReg
(
FCR
, 
FCR_FIFO_ENABLE
 | 
FCR_FIFO_CLEAR
);

75 
	`WrôeReg
(
IER
, 
IER_TX_ENABLE
 | 
IER_RX_ENABLE
);

77 
	`öôlock
(&
u¨t_tx_lock
, "uart");

78 
	}
}

87 
	$u¨çutc
(
c
)

89 
	`acquúe
(&
u¨t_tx_lock
);

91 if(
∑nicked
){

97 if(((
u¨t_tx_w
 + 1Ë% 
UART_TX_BUF_SIZE
Ë=
u¨t_tx_r
){

100 
	`¶ìp
(&
u¨t_tx_r
, &
u¨t_tx_lock
);

102 
u¨t_tx_buf
[
u¨t_tx_w
] = 
c
;

103 
u¨t_tx_w
 = (u¨t_tx_w + 1Ë% 
UART_TX_BUF_SIZE
;

104 
	`u¨t°¨t
();

105 
	`ªÀa£
(&
u¨t_tx_lock
);

109 
	}
}

116 
	$u¨çutc_sync
(
c
)

118 
	`push_off
();

120 if(
∑nicked
){

126 (
	`RódReg
(
LSR
Ë& 
LSR_TX_IDLE
) == 0)

128 
	`WrôeReg
(
THR
, 
c
);

130 
	`p›_off
();

131 
	}
}

138 
	$u¨t°¨t
()

141 if(
u¨t_tx_w
 =
u¨t_tx_r
){

146 if((
	`RódReg
(
LSR
Ë& 
LSR_TX_IDLE
) == 0){

153 
c
 = 
u¨t_tx_buf
[
u¨t_tx_r
];

154 
u¨t_tx_r
 = (u¨t_tx_∏+ 1Ë% 
UART_TX_BUF_SIZE
;

157 
	`wakeup
(&
u¨t_tx_r
);

159 
	`WrôeReg
(
THR
, 
c
);

161 
	}
}

166 
	$u¨tgëc
()

168 if(
	`RódReg
(
LSR
) & 0x01){

170  
	`RódReg
(
RHR
);

174 
	}
}

180 
	$u¨töå
()

184 
c
 = 
	`u¨tgëc
();

185 if(
c
 == -1)

187 
	`c⁄sﬁeöå
(
c
);

191 
	`acquúe
(&
u¨t_tx_lock
);

192 
	`u¨t°¨t
();

193 
	`ªÀa£
(&
u¨t_tx_lock
);

194 
	}
}

	@virtio.h

13 
	#VIRTIO_MMIO_MAGIC_VALUE
 0x000

14 
	#VIRTIO_MMIO_VERSION
 0x004

15 
	#VIRTIO_MMIO_DEVICE_ID
 0x008

16 
	#VIRTIO_MMIO_VENDOR_ID
 0x00c

17 
	#VIRTIO_MMIO_DEVICE_FEATURES
 0x010

	)

18 
	#VIRTIO_MMIO_DRIVER_FEATURES
 0x020

	)

19 
	#VIRTIO_MMIO_GUEST_PAGE_SIZE
 0x028

20 
	#VIRTIO_MMIO_QUEUE_SEL
 0x030

21 
	#VIRTIO_MMIO_QUEUE_NUM_MAX
 0x034

22 
	#VIRTIO_MMIO_QUEUE_NUM
 0x038

23 
	#VIRTIO_MMIO_QUEUE_ALIGN
 0x03c

24 
	#VIRTIO_MMIO_QUEUE_PFN
 0x040

25 
	#VIRTIO_MMIO_QUEUE_READY
 0x044

26 
	#VIRTIO_MMIO_QUEUE_NOTIFY
 0x050

27 
	#VIRTIO_MMIO_INTERRUPT_STATUS
 0x060

28 
	#VIRTIO_MMIO_INTERRUPT_ACK
 0x064

29 
	#VIRTIO_MMIO_STATUS
 0x070

30 

	)

32 
	#VIRTIO_CONFIG_S_ACKNOWLEDGE
 1

	)

33 
	#VIRTIO_CONFIG_S_DRIVER
 2

	)

34 
	#VIRTIO_CONFIG_S_DRIVER_OK
 4

	)

35 
	#VIRTIO_CONFIG_S_FEATURES_OK
 8

	)

38 
	#VIRTIO_BLK_F_RO
 5

	)

39 
	#VIRTIO_BLK_F_SCSI
 7

	)

40 
	#VIRTIO_BLK_F_CONFIG_WCE
 11

	)

41 
	#VIRTIO_BLK_F_MQ
 12

	)

42 
	#VIRTIO_F_ANY_LAYOUT
 27

	)

43 
	#VIRTIO_RING_F_INDIRECT_DESC
 28

	)

44 
	#VIRTIO_RING_F_EVENT_IDX
 29

	)

48 
	#NUM
 8

	)

50 
	sVRögDesc
 {

51 
uöt64
 
	maddr
;

52 
uöt32
 
	mÀn
;

53 
uöt16
 
	mÊags
;

54 
uöt16
 
	m√xt
;

56 
	#VRING_DESC_F_NEXT
 1

57 
	#VRING_DESC_F_WRITE
 2

58 

	)

59 
	sVRögU£dEÀm
 {

60 
uöt32
 
	mid
;

61 
uöt32
 
	mÀn
;

65 
	#VIRTIO_BLK_T_IN
 0

66 
	#VIRTIO_BLK_T_OUT
 1

67 

	)

68 
	sU£dAªa
 {

69 
uöt16
 
	mÊags
;

70 
uöt16
 
	mid
;

71 
VRögU£dEÀm
 
	mñems
[
NUM
];

	@virtio_disk.c

9 
	~"ty≥s.h
"

10 
	~"riscv.h
"

11 
	~"defs.h
"

12 
	~"∑øm.h
"

13 
	~"memœyout.h
"

14 
	~"•ölock.h
"

15 
	~"¶ì∂ock.h
"

16 
	~"fs.h
"

17 
	~"buf.h
"

18 
	~"vútio.h
"

21 
	#R
(
r
Ë((vﬁ©ûê
uöt32
 *)(
VIRTIO0
 + (r)))

	)

23 
	sdisk
 {

28 
	m∑ges
[2*
PGSIZE
];

29 
VRögDesc
 *
	mdesc
;

30 
uöt16
 *
	mavaû
;

31 
U£dAªa
 *
	mu£d
;

34 
	m‰ì
[
NUM
];

35 
uöt16
 
	mu£d_idx
;

41 
buf
 *
	mb
;

42 
	m°©us
;

43 } 
	möfo
[
NUM
];

45 
•ölock
 
	mvdisk_lock
;

47 } 
__©åibuã__
 ((
	$Æig√d
 (
PGSIZE
))Ë
disk
;

50 
	$vútio_disk_öô
()

52 
uöt32
 
°©us
 = 0;

54 
	`öôlock
(&
disk
.
vdisk_lock
, "virtio_disk");

56 if(*
	`R
(
VIRTIO_MMIO_MAGIC_VALUE
) != 0x74726976 ||

57 *
	`R
(
VIRTIO_MMIO_VERSION
) != 1 ||

58 *
	`R
(
VIRTIO_MMIO_DEVICE_ID
) != 2 ||

59 *
	`R
(
VIRTIO_MMIO_VENDOR_ID
) != 0x554d4551){

60 
	`∑nic
("couldÇot find virtio disk");

63 
°©us
 |
VIRTIO_CONFIG_S_ACKNOWLEDGE
;

64 *
	`R
(
VIRTIO_MMIO_STATUS
Ë
°©us
;

66 
°©us
 |
VIRTIO_CONFIG_S_DRIVER
;

67 *
	`R
(
VIRTIO_MMIO_STATUS
Ë
°©us
;

70 
uöt64
 
„©uªs
 = *
	`R
(
VIRTIO_MMIO_DEVICE_FEATURES
);

71 
„©uªs
 &~(1 << 
VIRTIO_BLK_F_RO
);

72 
„©uªs
 &~(1 << 
VIRTIO_BLK_F_SCSI
);

73 
„©uªs
 &~(1 << 
VIRTIO_BLK_F_CONFIG_WCE
);

74 
„©uªs
 &~(1 << 
VIRTIO_BLK_F_MQ
);

75 
„©uªs
 &~(1 << 
VIRTIO_F_ANY_LAYOUT
);

76 
„©uªs
 &~(1 << 
VIRTIO_RING_F_EVENT_IDX
);

77 
„©uªs
 &~(1 << 
VIRTIO_RING_F_INDIRECT_DESC
);

78 *
	`R
(
VIRTIO_MMIO_DRIVER_FEATURES
Ë
„©uªs
;

81 
°©us
 |
VIRTIO_CONFIG_S_FEATURES_OK
;

82 *
	`R
(
VIRTIO_MMIO_STATUS
Ë
°©us
;

85 
°©us
 |
VIRTIO_CONFIG_S_DRIVER_OK
;

86 *
	`R
(
VIRTIO_MMIO_STATUS
Ë
°©us
;

88 *
	`R
(
VIRTIO_MMIO_GUEST_PAGE_SIZE
Ë
PGSIZE
;

91 *
	`R
(
VIRTIO_MMIO_QUEUE_SEL
) = 0;

92 
uöt32
 
max
 = *
	`R
(
VIRTIO_MMIO_QUEUE_NUM_MAX
);

93 if(
max
 == 0)

94 
	`∑nic
("virtio disk hasÇo queue 0");

95 if(
max
 < 
NUM
)

96 
	`∑nic
("virtio disk max queueÅoo short");

97 *
	`R
(
VIRTIO_MMIO_QUEUE_NUM
Ë
NUM
;

98 
	`mem£t
(
disk
.
∑ges
, 0, (disk.pages));

99 *
	`R
(
VIRTIO_MMIO_QUEUE_PFN
Ë((
uöt64
)
disk
.
∑ges
Ë>> 
PGSHIFT
;

105 
disk
.
desc
 = (
VRögDesc
 *Ëdisk.
∑ges
;

106 
disk
.
avaû
 = (
uöt16
*)(((*)disk.
desc
Ë+ 
NUM
*(
VRögDesc
));

107 
disk
.
u£d
 = (
U£dAªa
 *Ë(disk.
∑ges
 + 
PGSIZE
);

109 
i
 = 0; i < 
NUM
; i++)

110 
disk
.
‰ì
[
i
] = 1;

113 
	}
}

117 
	$Æloc_desc
()

119 
i
 = 0; i < 
NUM
; i++){

120 if(
disk
.
‰ì
[
i
]){

121 
disk
.
‰ì
[
i
] = 0;

122  
i
;

126 
	}
}

130 
	$‰ì_desc
(
i
)

132 if(
i
 >
NUM
)

133 
	`∑nic
("virtio_disk_intr 1");

134 if(
disk
.
‰ì
[
i
])

135 
	`∑nic
("virtio_disk_intr 2");

136 
disk
.
desc
[
i
].
addr
 = 0;

137 
disk
.
‰ì
[
i
] = 1;

138 
	`wakeup
(&
disk
.
‰ì
[0]);

139 
	}
}

143 
	$‰ì_chaö
(
i
)

146 
	`‰ì_desc
(
i
);

147 if(
disk
.
desc
[
i
].
Êags
 & 
VRING_DESC_F_NEXT
)

148 
i
 = 
disk
.
desc
[i].
√xt
;

152 
	}
}

155 
	$Æloc3_desc
(*
idx
)

157 
i
 = 0; i < 3; i++){

158 
idx
[
i
] = 
	`Æloc_desc
();

159 if(
idx
[
i
] < 0){

160 
j
 = 0; j < 
i
; j++)

161 
	`‰ì_desc
(
idx
[
j
]);

166 
	}
}

169 
	$vútio_disk_rw
(
buf
 *
b
, 
wrôe
)

171 
uöt64
 
£˘‹
 = 
b
->
blockno
 * (
BSIZE
 / 512);

173 
	`acquúe
(&
disk
.
vdisk_lock
);

180 
idx
[3];

182 if(
	`Æloc3_desc
(
idx
) == 0) {

185 
	`¶ìp
(&
disk
.
‰ì
[0], &disk.
vdisk_lock
);

191 
	svútio_blk_outhdr
 {

192 
uöt32
 
ty≥
;

193 
uöt32
 
ª£rved
;

194 
uöt64
 
£˘‹
;

195 } 
buf0
;

197 if(
wrôe
)

198 
buf0
.
ty≥
 = 
VIRTIO_BLK_T_OUT
;

200 
buf0
.
ty≥
 = 
VIRTIO_BLK_T_IN
;

201 
buf0
.
ª£rved
 = 0;

202 
buf0
.
£˘‹
 = sector;

206 
disk
.
desc
[
idx
[0]].
addr
 = (
uöt64
Ë
	`kvm∑
((uöt64Ë&
buf0
);

207 
disk
.
desc
[
idx
[0]].
Àn
 = (
buf0
);

208 
disk
.
desc
[
idx
[0]].
Êags
 = 
VRING_DESC_F_NEXT
;

209 
disk
.
desc
[
idx
[0]].
√xt
 = idx[1];

211 
disk
.
desc
[
idx
[1]].
addr
 = (
uöt64
Ë
b
->
d©a
;

212 
disk
.
desc
[
idx
[1]].
Àn
 = 
BSIZE
;

213 if(
wrôe
)

214 
disk
.
desc
[
idx
[1]].
Êags
 = 0;

216 
disk
.
desc
[
idx
[1]].
Êags
 = 
VRING_DESC_F_WRITE
;

217 
disk
.
desc
[
idx
[1]].
Êags
 |
VRING_DESC_F_NEXT
;

218 
disk
.
desc
[
idx
[1]].
√xt
 = idx[2];

220 
disk
.
öfo
[
idx
[0]].
°©us
 = 0;

221 
disk
.
desc
[
idx
[2]].
addr
 = (
uöt64
Ë&disk.
öfo
[idx[0]].
°©us
;

222 
disk
.
desc
[
idx
[2]].
Àn
 = 1;

223 
disk
.
desc
[
idx
[2]].
Êags
 = 
VRING_DESC_F_WRITE
;

224 
disk
.
desc
[
idx
[2]].
√xt
 = 0;

227 
b
->
disk
 = 1;

228 
disk
.
öfo
[
idx
[0]].
b
 = b;

234 
disk
.
avaû
[2 + (disk.avaû[1] % 
NUM
)] = 
idx
[0];

235 
	`__sync_synchr⁄ize
();

236 
disk
.
avaû
[1] = disk.avail[1] + 1;

238 *
	`R
(
VIRTIO_MMIO_QUEUE_NOTIFY
) = 0;

241 
b
->
disk
 == 1) {

242 
	`¶ìp
(
b
, &
disk
.
vdisk_lock
);

245 
disk
.
öfo
[
idx
[0]].
b
 = 0;

246 
	`‰ì_chaö
(
idx
[0]);

248 
	`ªÀa£
(&
disk
.
vdisk_lock
);

249 
	}
}

252 
	$vútio_disk_öå
()

254 
	`acquúe
(&
disk
.
vdisk_lock
);

256 (
disk
.
u£d_idx
 % 
NUM
Ë!(disk.
u£d
->
id
 % NUM)){

257 
id
 = 
disk
.
u£d
->
ñems
[disk.
u£d_idx
].id;

259 if(
disk
.
öfo
[
id
].
°©us
 != 0)

260 
	`∑nic
("virtio_disk_intr status");

262 
disk
.
öfo
[
id
].
b
->disk = 0;

263 
	`wakeup
(
disk
.
öfo
[
id
].
b
);

265 
disk
.
u£d_idx
 = (disk.u£d_idx + 1Ë% 
NUM
;

267 *
	`R
(
VIRTIO_MMIO_INTERRUPT_ACK
Ë*R(
VIRTIO_MMIO_INTERRUPT_STATUS
) & 0x3;

269 
	`ªÀa£
(&
disk
.
vdisk_lock
);

270 
	}
}

	@vm.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"memœyout.h
"

4 
	~"ñf.h
"

5 
	~"riscv.h
"

6 
	~"defs.h
"

7 
	~"fs.h
"

8 
	~"•ölock.h
"

9 
	~"¥oc.h
"

13 
∑gëabÀ_t
 
	gkî√l_∑gëabÀ
;

15 
ëext
[];

17 
åampﬁöe
[];

24 
	$u£r_kvmm≠
(
∑gëabÀ_t
 
k∑gëabÀ
,
uöt64
 
va
, uöt64 
sz
,uöt64 
∑
, 
≥rm
)

26 if(
	`m≠∑ges
(
k∑gëabÀ
, 
va
, 
sz
, 
∑
, 
≥rm
) != 0){

27 
	`∑nic
("user_kvmmap");

29 
	}
}

30 
∑gëabÀ_t


31 
	$u£r_kvm¸óã
()

33 
∑gëabÀ_t
 
k∑gëabÀ
 = (∑gëabÀ_tË
	`kÆloc
();

34 
	`mem£t
(
k∑gëabÀ
, 0, 
PGSIZE
);

37 
	`u£r_kvmm≠
(
k∑gëabÀ
,
UART0
,
PGSIZE
, UART0, 
PTE_R
 | 
PTE_W
);

40 
	`u£r_kvmm≠
(
k∑gëabÀ
,
VIRTIO0
, 
PGSIZE
,VIRTIO0, 
PTE_R
 | 
PTE_W
);

46 
	`u£r_kvmm≠
(
k∑gëabÀ
,
PLIC
,0x400000,PLIC, 
PTE_R
 | 
PTE_W
);

49 
	`u£r_kvmm≠
(
k∑gëabÀ
,
KERNBASE
,(
uöt64
)
ëext
-KERNBASE,KERNBASE, 
PTE_R
 | 
PTE_X
);

52 
	`u£r_kvmm≠
(
k∑gëabÀ
,(
uöt64
)
ëext
,
PHYSTOP
-(uöt64Îãxt,(uöt64Îãxt, 
PTE_R
 | 
PTE_W
);

56 
	`u£r_kvmm≠
(
k∑gëabÀ
,
TRAMPOLINE
, 
PGSIZE
,(
uöt64
)
åampﬁöe
, 
PTE_R
 | 
PTE_X
);

57  
k∑gëabÀ
;

59 
	}
}

61 
	$kvmöô
()

63 
kî√l_∑gëabÀ
 = (
∑gëabÀ_t
Ë
	`kÆloc
();

64 
	`mem£t
(
kî√l_∑gëabÀ
, 0, 
PGSIZE
);

67 
	`kvmm≠
(
UART0
, UART0, 
PGSIZE
, 
PTE_R
 | 
PTE_W
);

70 
	`kvmm≠
(
VIRTIO0
, VIRTIO0, 
PGSIZE
, 
PTE_R
 | 
PTE_W
);

76 
	`kvmm≠
(
PLIC
, PLIC, 0x400000, 
PTE_R
 | 
PTE_W
);

79 
	`kvmm≠
(
KERNBASE
, KERNBASE, (
uöt64
)
ëext
-KERNBASE, 
PTE_R
 | 
PTE_X
);

82 
	`kvmm≠
((
uöt64
)
ëext
, (uöt64Îãxt, 
PHYSTOP
-(uöt64Îãxt, 
PTE_R
 | 
PTE_W
);

86 
	`kvmm≠
(
TRAMPOLINE
, (
uöt64
)
åampﬁöe
, 
PGSIZE
, 
PTE_R
 | 
PTE_X
);

87 
	}
}

92 
	$kvmöôh¨t
()

94 
	`w_ßç
(
	`MAKE_SATP
(
kî√l_∑gëabÀ
));

95 
	`s„n˚_vma
();

96 
	}
}

110 
±e_t
 *

111 
	$wÆk
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
, 
Æloc
)

113 if(
va
 >
MAXVA
)

114 
	`∑nic
("walk");

116 
Àvñ
 = 2;Üevel > 0;Üevel--) {

117 
±e_t
 *
±e
 = &
∑gëabÀ
[
	`PX
(
Àvñ
, 
va
)];

118 if(*
±e
 & 
PTE_V
) {

119 
∑gëabÀ
 = (
∑gëabÀ_t
)
	`PTE2PA
(*
±e
);

121 if(!
Æloc
 || (
∑gëabÀ
 = (
pde_t
*)
	`kÆloc
()) == 0)

123 
	`mem£t
(
∑gëabÀ
, 0, 
PGSIZE
);

124 *
±e
 = 
	`PA2PTE
(
∑gëabÀ
Ë| 
PTE_V
;

127  &
∑gëabÀ
[
	`PX
(0, 
va
)];

128 
	}
}

133 
uöt64


134 
	$wÆkaddr
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
)

136 
±e_t
 *
±e
;

137 
uöt64
 
∑
;

139 if(
va
 >
MAXVA
)

142 
±e
 = 
	`wÆk
(
∑gëabÀ
, 
va
, 0);

143 if(
±e
 == 0)

145 if((*
±e
 & 
PTE_V
) == 0)

147 if((*
±e
 & 
PTE_U
) == 0)

149 
∑
 = 
	`PTE2PA
(*
±e
);

150  
∑
;

151 
	}
}

157 
	$kvmm≠
(
uöt64
 
va
, uöt64 
∑
, uöt64 
sz
, 
≥rm
)

159 if(
	`m≠∑ges
(
kî√l_∑gëabÀ
, 
va
, 
sz
, 
∑
, 
≥rm
) != 0)

160 
	`∑nic
("kvmmap");

161 
	}
}

167 
uöt64


168 
	$kvm∑
(
uöt64
 
va
)

170 
uöt64
 
off
 = 
va
 % 
PGSIZE
;

171 
±e_t
 *
±e
;

172 
uöt64
 
∑
;

174 
±e
 = 
	`wÆk
(
	`my¥oc
()->
k∑gëabÀ
, 
va
, 0);

175 if(
±e
 == 0)

176 
	`∑nic
("kvmpa");

177 if((*
±e
 & 
PTE_V
) == 0)

178 
	`∑nic
("kvmpa");

179 
∑
 = 
	`PTE2PA
(*
±e
);

180  
∑
+
off
;

181 
	}
}

188 
	$m≠∑ges
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
, uöt64 
size
, uöt64 
∑
, 
≥rm
)

190 
uöt64
 
a
, 
œ°
;

191 
±e_t
 *
±e
;

193 
a
 = 
	`PGROUNDDOWN
(
va
);

194 
œ°
 = 
	`PGROUNDDOWN
(
va
 + 
size
 - 1);

196 if((
±e
 = 
	`wÆk
(
∑gëabÀ
, 
a
, 1)) == 0){

199 if(*
±e
 & 
PTE_V
){

200 
	`¥ötf
("v®%p,∑ = %p\n",
a
,
	`PTE2PA
(*
	`wÆk
(
∑gëabÀ
,a,0)));

201 
	`∑nic
("remap");

203 *
±e
 = 
	`PA2PTE
(
∑
Ë| 
≥rm
 | 
PTE_V
;

204 if(
a
 =
œ°
)

206 
a
 +
PGSIZE
;

207 
∑
 +
PGSIZE
;

210 
	}
}

216 
	$uvmunm≠
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
, uöt64 
≈ages
, 
do_‰ì
)

218 
uöt64
 
a
;

219 
±e_t
 *
±e
;

221 if((
va
 % 
PGSIZE
) != 0)

222 
	`∑nic
("uvmunmap:Çotáligned");

224 
a
 = 
va
;á < v®+ 
≈ages
*
PGSIZE
;á += PGSIZE){

225 if((
±e
 = 
	`wÆk
(
∑gëabÀ
, 
a
, 0)) == 0){

226 
	`¥ötf
("v®%p",
a
);

227 
	`∑nic
("uvmunmap: walk");

229 if((*
±e
 & 
PTE_V
) == 0){

230 
	`∑nic
("uvmunmap:Çot mapped");

232 if(
	`PTE_FLAGS
(*
±e
Ë=
PTE_V
)

233 
	`∑nic
("uvmunmap:ÇotáÜeaf");

234 if(
do_‰ì
){

235 
uöt64
 
∑
 = 
	`PTE2PA
(*
±e
);

236 
	`k‰ì
((*)
∑
);

238 *
±e
 = 0;

240 
	}
}

244 
∑gëabÀ_t


245 
	$uvm¸óã
()

247 
∑gëabÀ_t
 
∑gëabÀ
;

248 
∑gëabÀ
 = (
∑gëabÀ_t
Ë
	`kÆloc
();

249 if(
∑gëabÀ
 == 0)

251 
	`mem£t
(
∑gëabÀ
, 0, 
PGSIZE
);

252  
∑gëabÀ
;

253 
	}
}

259 
	$uvmöô
(
∑gëabÀ_t
 
∑gëabÀ
, 
uch¨
 *
§c
, 
uöt
 
sz
)

261 *
mem
;

263 if(
sz
 >
PGSIZE
)

264 
	`∑nic
("inituvm: moreÅhanáÖage");

265 
mem
 = 
	`kÆloc
();

266 
	`mem£t
(
mem
, 0, 
PGSIZE
);

267 
	`m≠∑ges
(
∑gëabÀ
, 0, 
PGSIZE
, (
uöt64
)
mem
, 
PTE_W
|
PTE_R
|
PTE_X
|
PTE_U
);

268 
	`memmove
(
mem
, 
§c
, 
sz
);

269 
	}
}

273 
uöt64


274 
	$uvmÆloc
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
ﬁdsz
, uöt64 
√wsz
)

276 *
mem
;

277 
uöt64
 
a
;

278 if(
√wsz
 > 
PLIC
){

279 
	`¥ötf
("out of PLIC\n");

282 if(
√wsz
 < 
ﬁdsz
)

283  
ﬁdsz
;

285 
ﬁdsz
 = 
	`PGROUNDUP
(oldsz);

286 
a
 = 
ﬁdsz
;á < 
√wsz
;á +
PGSIZE
){

287 
mem
 = 
	`kÆloc
();

288 if(
mem
 == 0){

289 
	`uvmdóŒoc
(
∑gëabÀ
, 
a
, 
ﬁdsz
);

292 
	`mem£t
(
mem
, 0, 
PGSIZE
);

293 if(
	`m≠∑ges
(
∑gëabÀ
, 
a
, 
PGSIZE
, (
uöt64
)
mem
, 
PTE_W
|
PTE_X
|
PTE_R
|
PTE_U
) != 0){

294 
	`k‰ì
(
mem
);

295 
	`uvmdóŒoc
(
∑gëabÀ
, 
a
, 
ﬁdsz
);

299  
√wsz
;

300 
	}
}

306 
uöt64


307 
	$uvmdóŒoc
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
ﬁdsz
, uöt64 
√wsz
)

309 if(
√wsz
 >
ﬁdsz
)

310  
ﬁdsz
;

311 if(
	`PGROUNDUP
(
√wsz
Ë< PGROUNDUP(
ﬁdsz
)){

312 
≈ages
 = (
	`PGROUNDUP
(
ﬁdsz
Ë- PGROUNDUP(
√wsz
)Ë/ 
PGSIZE
;

313 
	`uvmunm≠
(
∑gëabÀ
, 
	`PGROUNDUP
(
√wsz
), 
≈ages
, 1);

316  
√wsz
;

317 
	}
}

318 
uöt64


319 
	$kvmdóŒoc
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
ﬁdsz
, uöt64 
√wsz
)

321 if(
√wsz
 >
ﬁdsz
)

322  
ﬁdsz
;

323 if(
	`PGROUNDUP
(
√wsz
Ë< PGROUNDUP(
ﬁdsz
)){

324 
≈ages
 = (
	`PGROUNDUP
(
ﬁdsz
Ë- PGROUNDUP(
√wsz
)Ë/ 
PGSIZE
;

325 
	`uvmunm≠
(
∑gëabÀ
, 
	`PGROUNDUP
(
√wsz
), 
≈ages
, 0);

328  
√wsz
;

329 
	}
}

334 
	$‰ìwÆk
(
∑gëabÀ_t
 
∑gëabÀ
)

337 
i
 = 0; i < 512; i++){

338 
±e_t
 
±e
 = 
∑gëabÀ
[
i
];

339 if((
±e
 & 
PTE_V
Ë&& (±ê& (
PTE_R
|
PTE_W
|
PTE_X
)) == 0){

341 
uöt64
 
chûd
 = 
	`PTE2PA
(
±e
);

342 
	`‰ìwÆk
((
∑gëabÀ_t
)
chûd
);

343 
∑gëabÀ
[
i
] = 0;

344 } if(
±e
 & 
PTE_V
){

345 
	`¥ötf
("Àa‡∑ = %p\n",
	`PTE2PA
(
±e
));

346 
	`∑nic
("freewalk:Üeaf");

349 
	`k‰ì
((*)
∑gëabÀ
);

350 
	}
}

351 
	$k‰ìwÆk
(
∑gëabÀ_t
 
k∑gëabÀ
){

353 
i
 = 0; i < 512; i++){

354 
±e_t
 
±e
 = 
k∑gëabÀ
[
i
];

355 if((
±e
 & 
PTE_V
)){

357 if((
±e
 & (
PTE_R
|
PTE_W
|
PTE_X
)) == 0){

358 
uöt64
 
chûd
 = 
	`PTE2PA
(
±e
);

359 
	`k‰ìwÆk
((
∑gëabÀ_t
)
chûd
);

361 
k∑gëabÀ
[
i
] = 0;

364 
	`k‰ì
((*)
k∑gëabÀ
);

366 
	}
}

367 
	$u£r_kvm‰ì
(
∑gëabÀ_t
 
k∑gëabÀ
){

368 
	`k‰ìwÆk
(
k∑gëabÀ
);

369 
	}
}

374 
	$uvm‰ì
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
sz
)

376 if(
sz
 > 0)

377 
	`uvmunm≠
(
∑gëabÀ
, 0, 
	`PGROUNDUP
(
sz
)/
PGSIZE
, 1);

378 
	`‰ìwÆk
(
∑gëabÀ
);

379 
	}
}

388 
	$uvmc›y
(
∑gëabÀ_t
 
ﬁd
,ÖagëabÀ_à
√w
, 
uöt64
 
sz
)

390 
±e_t
 *
±e
;

391 
uöt64
 
∑
, 
i
;

392 
uöt
 
Êags
;

393 *
mem
;

395 
i
 = 0; i < 
sz
; i +
PGSIZE
){

396 if((
±e
 = 
	`wÆk
(
ﬁd
, 
i
, 0)) == 0)

397 
	`∑nic
("uvmcopy:Öte shouldÉxist");

398 if((*
±e
 & 
PTE_V
) == 0)

399 
	`∑nic
("uvmcopy:ÖageÇotÖresent");

400 
∑
 = 
	`PTE2PA
(*
±e
);

401 
Êags
 = 
	`PTE_FLAGS
(*
±e
);

402 if((
mem
 = 
	`kÆloc
()) == 0)

403 
îr
;

404 
	`memmove
(
mem
, (*)
∑
, 
PGSIZE
);

405 if(
	`m≠∑ges
(
√w
, 
i
, 
PGSIZE
, (
uöt64
)
mem
, 
Êags
) != 0){

406 
	`k‰ì
(
mem
);

407 
îr
;

412 
îr
:

413 
	`uvmunm≠
(
√w
, 0, 
i
 / 
PGSIZE
, 1);

415 
	}
}

417 
	$kvmc›y
(
∑gëabÀ_t
 
ﬁd
,ÖagëabÀ_à
√w
,
uöt64
 
ﬁdsz
, uöt64 
√wsz
)

419 
±e_t
 *
±e
;

420 
uöt64
 
∑
, 
i
;

421 
uöt
 
Êags
;

422 
ﬁdsz
 = 
	`PGROUNDUP
(oldsz);

423 
i
 = 
ﬁdsz
; i < 
√wsz
; i +
PGSIZE
){

424 if((
±e
 = 
	`wÆk
(
ﬁd
, 
i
, 0)) == 0)

425 
	`∑nic
("kvmcopy:Öte shouldÉxist");

426 if((*
±e
 & 
PTE_V
) == 0)

427 
	`∑nic
("kvmcopy:ÖageÇotÖresent");

428 
∑
 = 
	`PTE2PA
(*
±e
);

429 
Êags
 = 
	`PTE_FLAGS
(*
±e
Ë& ~
PTE_U
;

430 if(
	`m≠∑ges
(
√w
, 
i
, 
PGSIZE
, (
uöt64
)
∑
, 
Êags
) != 0){

431 
îr
;

436 
îr
:

437 
	`¥ötf
("kvmcopyÉrr\n");

438 
	`uvmunm≠
(
√w
, 
ﬁdsz
, 
i
 / 
PGSIZE
, 1);

440 
	}
}

445 
	$uvm˛ór
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
va
)

447 
±e_t
 *
±e
;

449 
±e
 = 
	`wÆk
(
∑gëabÀ
, 
va
, 0);

450 if(
±e
 == 0)

451 
	`∑nic
("uvmclear");

452 *
±e
 &~
PTE_U
;

453 
	}
}

459 
	$c›yout
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
d°va
, *
§c
, uöt64 
Àn
)

461 
uöt64
 
n
, 
va0
, 
∑0
;

463 
Àn
 > 0){

464 
va0
 = 
	`PGROUNDDOWN
(
d°va
);

465 
∑0
 = 
	`wÆkaddr
(
∑gëabÀ
, 
va0
);

466 if(
∑0
 == 0)

468 
n
 = 
PGSIZE
 - (
d°va
 - 
va0
);

469 if(
n
 > 
Àn
)

470 
n
 = 
Àn
;

471 
	`memmove
((*)(
∑0
 + (
d°va
 - 
va0
)), 
§c
, 
n
);

473 
Àn
 -
n
;

474 
§c
 +
n
;

475 
d°va
 = 
va0
 + 
PGSIZE
;

478 
	}
}

480 
	$kc›yout
(
∑gëabÀ_t
 
∑gëabÀ
, 
uöt64
 
d°va
, *
§c
, uöt64 
Àn
)

482 
uöt64
 
n
, 
va0
, 
∑0
;

484 
Àn
 > 0){

485 
va0
 = 
	`PGROUNDDOWN
(
d°va
);

486 
∑0
 = 
	`PTE2PA
(*
	`wÆk
(
∑gëabÀ
, 
va0
, 0));

487 if(
∑0
 == 0)

489 
n
 = 
PGSIZE
 - (
d°va
 - 
va0
);

490 if(
n
 > 
Àn
)

491 
n
 = 
Àn
;

492 
	`memmove
((*)(
∑0
 + (
d°va
 - 
va0
)), 
§c
, 
n
);

494 
Àn
 -
n
;

495 
§c
 +
n
;

496 
d°va
 = 
va0
 + 
PGSIZE
;

499 
	}
}

504 
	$c›yö
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
Àn
)

523  
	`c›yö_√w
(
∑gëabÀ
,
d°
,
§cva
,
Àn
);

524 
	}
}

531 
	$c›yö°r
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
max
)

567  
	`c›yö°r_√w
(
∑gëabÀ
,
d°
,
§cva
,
max
);

568 
	}
}

570 
	$vm¥öt_hñ≥r
(
∑gëabÀ_t
 
∑gëabÀ
,
Àvñ
){

571 if(
Àvñ
 > 3)

573 
i
 = 0; i < 512; i++){

574 
±e_t
 
±e
 = 
∑gëabÀ
[
i
];

575 if(
±e
 & 
PTE_V
){

576 
uöt64
 
chûd
 = 
	`PTE2PA
(
±e
);

577 
j
 = 0; j < 
Àvñ
; j++)

578 
	`¥ötf
(" ..");

579 
	`¥ötf
("%d:Öã %∞∑ %p\n",
i
,
±e
,
chûd
);

580 
	`vm¥öt_hñ≥r
((
∑gëabÀ_t
)
chûd
,
Àvñ
+1);

583 
	}
}

584 
	$vm¥öt
(
∑gëabÀ_t
 
∑gëabÀ
){

585 
	`¥ötf
("∑gêèbÀ %p\n",
∑gëabÀ
);

586 
	`vm¥öt_hñ≥r
(
∑gëabÀ
,1);

588 
	}
}

	@vmcopyin.c

1 
	~"∑øm.h
"

2 
	~"ty≥s.h
"

3 
	~"riscv.h
"

4 
	~"defs.h
"

5 
	~"•ölock.h
"

6 
	~"¥oc.h
"

13 
	s°©s
 {

14 
	mnc›yö
;

15 
	mnc›yö°r
;

16 } 
	g°©s
;

19 
	$°©sc›yö
(*
buf
, 
sz
) {

20 
n
;

21 
n
 = 
	`¢¥ötf
(
buf
, 
sz
, "c›yö: %d\n", 
°©s
.
nc›yö
);

22 
n
 +
	`¢¥ötf
(
buf
+n, 
sz
, "c›yö°r: %d\n", 
°©s
.
nc›yö°r
);

23  
n
;

24 
	}
}

30 
	$c›yö_√w
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
Àn
)

32 
¥oc
 *
p
 = 
	`my¥oc
();

34 i‡(
§cva
 >
p
->
sz
 || srcva+
Àn
 >=Ö->sz || srcva+len < srcva)

36 
	`memmove
((*Ë
d°
, (*)
§cva
, 
Àn
);

37 
°©s
.
nc›yö
++;

39 
	}
}

46 
	$c›yö°r_√w
(
∑gëabÀ_t
 
∑gëabÀ
, *
d°
, 
uöt64
 
§cva
, uöt64 
max
)

48 
¥oc
 *
p
 = 
	`my¥oc
();

49 *
s
 = (*Ë
§cva
;

51 
°©s
.
nc›yö°r
++;

52 
i
 = 0; i < 
max
 && 
§cva
 + i < 
p
->
sz
; i++){

53 
d°
[
i
] = 
s
[i];

54 if(
s
[
i
] == '\0')

58 
	}
}

	@
1
.
0
44
367
bio.c
buf.h
console.c
date.h
defs.h
elf.h
exec.c
fcntl.h
file.c
file.h
fs.c
fs.h
kalloc.c
log.c
main.c
memlayout.h
param.h
pipe.c
plic.c
printf.c
proc.c
proc.h
ramdisk.c
riscv.h
sleeplock.c
sleeplock.h
spinlock.c
spinlock.h
sprintf.c
start.c
stat.h
stats.c
string.c
syscall.c
syscall.h
sysfile.c
sysproc.c
trap.c
types.h
uart.c
virtio.h
virtio_disk.c
vm.c
vmcopyin.c
